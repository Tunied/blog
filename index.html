<!DOCTYPE html>




<html class="theme-next gemini" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="HaFr6IFRWpWkG_Eyt4dUUQlgTyTE85bMpbJKQQgp0Rw" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="独立游戏开发者">
<meta property="og:type" content="website">
<meta property="og:title" content="隔壁老王">
<meta property="og:url" content="http://www.oldking.wang/index.html">
<meta property="og:site_name" content="隔壁老王">
<meta property="og:description" content="独立游戏开发者">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="隔壁老王">
<meta name="twitter:description" content="独立游戏开发者">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.oldking.wang/"/>





  <title>隔壁老王 - 独立游戏开发者</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-111727312-1', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">隔壁老王</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">独立游戏开发者</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-unity">
          <a href="/categories/Unity" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-diamond"></i> <br />
            
            Unity
          </a>
        </li>
      
        
        <li class="menu-item menu-item-编程">
          <a href="/categories/编程" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-graduation-cap"></i> <br />
            
            编程
          </a>
        </li>
      
        
        <li class="menu-item menu-item-其他">
          <a href="/categories/其他" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-beer"></i> <br />
            
            其他
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.oldking.wang/cb07f070-ae97-11e8-9414-077be260bdcd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/cb07f070-ae97-11e8-9414-077be260bdcd/" itemprop="url">Lua从入门到入了门(6) OOP深入分析之Oldking版</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-02T18:00:06+08:00">
                2018-09-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="拿走直接用版"><a href="#拿走直接用版" class="headerlink" title="拿走直接用版"></a>拿走直接用版</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">class</span><span class="params">(super)</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">local</span> newClass = &#123;&#125;</span><br><span class="line">    newClass.super = super</span><br><span class="line">    newClass.<span class="built_in">__index</span> = newClass</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">newClass.new</span><span class="params">(...)</span></span></span><br><span class="line">        <span class="keyword">local</span> o = &#123;&#125;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">local</span> <span class="built_in">create</span></span><br><span class="line">            <span class="built_in">create</span> = <span class="function"><span class="keyword">function</span><span class="params">(_class, ...)</span></span></span><br><span class="line">                <span class="keyword">if</span> _class.super <span class="keyword">then</span></span><br><span class="line">                    <span class="built_in">create</span>(_class.super, ...)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">if</span> _class.ctor <span class="keyword">then</span></span><br><span class="line">                    _class.ctor(o, ...)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            <span class="built_in">create</span>(newClass, ...)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">setmetatable</span>(o, newClass)</span><br><span class="line">        <span class="keyword">return</span> o</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> super <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">setmetatable</span>(newClass, &#123;<span class="built_in">__index</span> =</span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="params">(t, k)</span></span></span><br><span class="line">                <span class="keyword">local</span> v = super[k];</span><br><span class="line">                newClass[k] = v</span><br><span class="line">                <span class="keyword">return</span> v</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> newClass</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>将如上代码封装为<code>ClassE.lua</code>,然后创建如下lua文件</p>
<p><code>Animal.lua</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">AnimalClass = class()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AnimalClass:ctor</span><span class="params">(_name)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"call animal ctor name is: "</span>.._name)</span><br><span class="line">    self.mName = _name</span><br><span class="line">    self.mFood = <span class="string">"normal food"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AnimalClass:SayHI</span><span class="params">(_msg)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"Animal %s say hi with msg : %s"</span>, self.mName, _msg))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AnimalClass:Eat</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"Animal %s eat with food : %s"</span>, self.mName, self:GetEatFood()))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AnimalClass:GetEatFood</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> self.mFood</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><code>Cat.lua</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">CatClass = class(AnimalClass)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CatClass:ctor</span><span class="params">(_name, _color)</span></span></span><br><span class="line">    <span class="comment">--CatClass.super.ctor(self, _name)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"call cat ctor name is: %s color is %s"</span>, _name, _color))</span><br><span class="line">    self.mColor = _color</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CatClass:SayHI</span><span class="params">(_msg)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[Override] CatClass start"</span>)</span><br><span class="line">    CatClass.super.SayHI(self, _msg)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[Override] CatClass end"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CatClass:GetEatFood</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Fish"</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><code>main.lua</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">"ClassE"</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"Animal"</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"Cat"</span>)</span><br><span class="line"></span><br><span class="line">a1 = AnimalClass.new(<span class="string">"A1"</span>)</span><br><span class="line">a1:SayHI(<span class="string">"oh~"</span>)</span><br><span class="line">a1:Eat()</span><br><span class="line"></span><br><span class="line">c1 = CatClass.new(<span class="string">"C1"</span>,<span class="string">"Red"</span>)</span><br><span class="line">c1:SayHI(<span class="string">"oh~"</span>)</span><br><span class="line">c1:Eat()</span><br></pre></td></tr></table></figure>
<p>执行结果</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">call animal ctor name is: A1</span><br><span class="line"></span><br><span class="line">Animal A1 say hi with msg : oh~</span><br><span class="line">Animal A1 eat with food : normal food</span><br><span class="line"></span><br><span class="line">call animal ctor name is: C1</span><br><span class="line">call cat ctor name is: C1 color is Red</span><br><span class="line"></span><br><span class="line">[Override] CatClass start</span><br><span class="line">Animal C1 say hi with msg : oh~</span><br><span class="line">[Override] CatClass <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Animal C1 eat with food : Fish</span><br></pre></td></tr></table></figure>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>这个代码其实就是<a href="http://oldking.wang/91a7d430-ae97-11e8-8886-2901af87d97e/" target="_blank" rel="noopener">Quick版</a> 和 <a href="http://oldking.wang/905e8b50-ae97-11e8-980c-c39a9b9cf992/" target="_blank" rel="noopener">风神版</a> 的结合体. 有Quick版实现的简约,同时又有风神版<code>Write On Use</code>特性. 并且还支持调用父类同名函数</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CatClass.super.SayHI(self, _msg)</span><br></pre></td></tr></table></figure>
<p>好了,自夸结束. 用一句广告结尾好了</p>
<blockquote>
<p>我们不生产水 我们只是大自然的搬运工 😂😂😂</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.oldking.wang/905e8b50-ae97-11e8-980c-c39a9b9cf992/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/905e8b50-ae97-11e8-980c-c39a9b9cf992/" itemprop="url">Lua从入门到入了门(5) OOP深入分析之风云版</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-02T18:00:05+08:00">
                2018-09-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="原始实现"><a href="#原始实现" class="headerlink" title="原始实现"></a>原始实现</h2><p><a href="https://blog.codingnow.com/cloud/LuaOO" target="_blank" rel="noopener">源码连接</a><br><a href="https://blog.codingnow.com/2006/06/oo_lua.html" target="_blank" rel="noopener">原文</a></p>
<p>具体代码:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> _class=&#123;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">class</span><span class="params">(super)</span></span></span><br><span class="line">	<span class="keyword">local</span> class_type=&#123;&#125;</span><br><span class="line">	class_type.ctor=<span class="literal">false</span></span><br><span class="line">	class_type.super=super</span><br><span class="line">	class_type.new=<span class="function"><span class="keyword">function</span><span class="params">(...)</span></span> </span><br><span class="line">			<span class="keyword">local</span> obj=&#123;&#125;</span><br><span class="line">			<span class="keyword">do</span></span><br><span class="line">				<span class="keyword">local</span> <span class="built_in">create</span></span><br><span class="line">				<span class="built_in">create</span> = <span class="function"><span class="keyword">function</span><span class="params">(c,...)</span></span></span><br><span class="line">					<span class="keyword">if</span> c.super <span class="keyword">then</span></span><br><span class="line">						<span class="built_in">create</span>(c.super,...)</span><br><span class="line">					<span class="keyword">end</span></span><br><span class="line">					<span class="keyword">if</span> c.ctor <span class="keyword">then</span></span><br><span class="line">						c.ctor(obj,...)</span><br><span class="line">					<span class="keyword">end</span></span><br><span class="line">				<span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line">				<span class="built_in">create</span>(class_type,...)</span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line">			<span class="built_in">setmetatable</span>(obj,&#123; <span class="built_in">__index</span>=_class[class_type] &#125;)</span><br><span class="line">			<span class="keyword">return</span> obj</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">local</span> vtbl=&#123;&#125;</span><br><span class="line">	_class[class_type]=vtbl</span><br><span class="line"> </span><br><span class="line">	<span class="built_in">setmetatable</span>(class_type,&#123;<span class="built_in">__newindex</span>=</span><br><span class="line">		<span class="function"><span class="keyword">function</span><span class="params">(t,k,v)</span></span></span><br><span class="line">			vtbl[k]=v</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	&#125;)</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">if</span> super <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">setmetatable</span>(vtbl,&#123;<span class="built_in">__index</span>=</span><br><span class="line">			<span class="function"><span class="keyword">function</span><span class="params">(t,k)</span></span></span><br><span class="line">				<span class="keyword">local</span> ret=_class[super][k]</span><br><span class="line">				vtbl[k]=ret</span><br><span class="line">				<span class="keyword">return</span> ret</span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line">		&#125;)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line">	<span class="keyword">return</span> class_type</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>和<a href="http://oldking.wang/91a7d430-ae97-11e8-8886-2901af87d97e/" target="_blank" rel="noopener">QuickX的Demo</a>基本相同</p>
<p>将如上函数保存为<code>ClassF.lua</code></p>
<p>再创建如下文件</p>
<p><code>AnimalClass.lua</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">AnimalClass = class()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AnimalClass:ctor</span><span class="params">(_name)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"call animal ctor name is: "</span>.._name)</span><br><span class="line">    self.mName = _name</span><br><span class="line">    self.mFood = <span class="string">"normal food"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AnimalClass:SayHI</span><span class="params">(_msg)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"Animal %s say hi with msg : %s"</span>, self.mName, _msg))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AnimalClass:Eat</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"Animal %s eat with food : %s"</span>, self.mName, self:GetEatFood()))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AnimalClass:GetEatFood</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> self.mFood</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><code>Cat.lua</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CatClass = class(AnimalClass)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CatClass:ctor</span><span class="params">(_name, _color)</span></span></span><br><span class="line">    <span class="comment">--CatClass.super.ctor(self, _name)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"call cat ctor name is: %s color is %s"</span>, _name, _color))</span><br><span class="line">    self.mColor = _color</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CatClass:SayHI</span><span class="params">(_msg)</span></span></span><br><span class="line">    <span class="comment">--CatClass.super.SayHI(self, _msg)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[Override] CatClass called"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CatClass:GetEatFood</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Fish"</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>入口文件<code>main.lua</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">"ClassF"</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"Animal"</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"Cat"</span>)</span><br><span class="line"></span><br><span class="line">a1 = AnimalClass.new(<span class="string">"A1"</span>)</span><br><span class="line">a1:SayHI(<span class="string">"oh~"</span>)</span><br><span class="line">a1:Eat()</span><br><span class="line"></span><br><span class="line">c1 = CatClass.new(<span class="string">"C1"</span>,<span class="string">"Red"</span>)</span><br><span class="line">c1:SayHI(<span class="string">"oh~"</span>)</span><br><span class="line">c1:Eat()</span><br></pre></td></tr></table></figure>
<p>输出结果为:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">call animal ctor name is: A1</span><br><span class="line"></span><br><span class="line">Animal A1 say hi with msg : oh~</span><br><span class="line">Animal A1 eat with food : normal food</span><br><span class="line"></span><br><span class="line">call animal ctor name is: C1</span><br><span class="line">call cat ctor name is: C1 color is Red</span><br><span class="line"></span><br><span class="line">[Override] CatClass called</span><br><span class="line">Animal C1 eat with food : Fish</span><br></pre></td></tr></table></figure>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>Demo代码基本上和QuickX的那个相同,只是<code>class</code>定义初无需再传入<code>className</code>了,同时<code>Cat.lua</code>中注释掉了两行</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--CatClass.super.ctor(self, _name)</span></span><br><span class="line"><span class="comment">--CatClass.super.SayHI(self, _msg)</span></span><br></pre></td></tr></table></figure>
<p><code>ctor</code>那个为无需手动调用,<code>SayHI</code>这个为无法实现. </p>
<p>下面我就来分析下原因</p>
<h3 id="事先了解"><a href="#事先了解" class="headerlink" title="事先了解"></a>事先了解</h3><blockquote>
<p> 如果你对为何能等效转换及2B情景法有疑问,请看我之前的文章: <a href="http://oldking.wang/fe8c5fe0-ae96-11e8-abfb-e54ee4891837/" target="_blank" rel="noopener">Lua从入门到入了门(2) 基础难点概述</a></p>
</blockquote>
<h3 id="等效转换"><a href="#等效转换" class="headerlink" title="等效转换"></a>等效转换</h3><p>风神的代码初看是很懵圈的,老一代艺术家,在代码中沉浸了多年 随便抖两笔 所表达出的意境 都需要我等凡夫俗子 花许久 参悟参悟的😂😂😂</p>
<p>为了方便我等俗人理解,我就破坏一下美感把代码给改Low一下,方便研读一下😑</p>
<p>通俗版代码如下:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">local</span> mAllClassMetatableCoreCache = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">class</span><span class="params">(superFromArg)</span></span></span><br><span class="line">    <span class="keyword">local</span> NewClass = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> NewClassMetatableCore = &#123;&#125;</span><br><span class="line">    mAllClassMetatableCoreCache[NewClass] = NewClassMetatableCore</span><br><span class="line">    </span><br><span class="line">    NewClass.ctor = <span class="literal">false</span></span><br><span class="line">    NewClass.super = superFromArg</span><br><span class="line">    NewClass.new = <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span></span><br><span class="line">        <span class="keyword">local</span> _newInstance = &#123;&#125;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">local</span> <span class="built_in">create</span></span><br><span class="line">            <span class="built_in">create</span> = <span class="function"><span class="keyword">function</span><span class="params">(_class, ...)</span></span></span><br><span class="line">                <span class="keyword">if</span> _class.super <span class="keyword">then</span></span><br><span class="line">                    <span class="built_in">create</span>(_class.super, ...)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">if</span> _class.ctor <span class="keyword">then</span></span><br><span class="line">                    _class.ctor(_newInstance, ...)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            <span class="built_in">create</span>(NewClass, ...)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="built_in">setmetatable</span>(_newInstance, &#123;<span class="built_in">__index</span> = NewClassMetatableCore&#125;)</span><br><span class="line">        <span class="keyword">return</span> _newInstance</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">setmetatable</span>(NewClass, &#123;<span class="built_in">__newindex</span> =</span><br><span class="line">        <span class="function"><span class="keyword">function</span><span class="params">(t, k, v)</span></span></span><br><span class="line">            NewClassMetatableCore[k] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> superFromArg <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">setmetatable</span>(NewClassMetatableCore, &#123;<span class="built_in">__index</span> =</span><br><span class="line">            <span class="function"><span class="keyword">function</span><span class="params">(t, k)</span></span></span><br><span class="line">                <span class="keyword">local</span> ret = mAllClassMetatableCoreCache[superFromArg][k]</span><br><span class="line">                NewClassMetatableCore[k] = ret</span><br><span class="line">                <span class="keyword">return</span> ret</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> NewClass</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="拆解分析"><a href="#拆解分析" class="headerlink" title="拆解分析"></a>拆解分析</h3><h4 id="new函数"><a href="#new函数" class="headerlink" title="new函数"></a>new函数</h4><p>还是和之前一样 先来分析一下看似简单的new函数</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">NewClass.new = <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">local</span> _newInstance = &#123;&#125;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> <span class="built_in">create</span></span><br><span class="line">        <span class="built_in">create</span> = <span class="function"><span class="keyword">function</span><span class="params">(_class, ...)</span></span></span><br><span class="line">            <span class="keyword">if</span> _class.super <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">create</span>(_class.super, ...)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">if</span> _class.ctor <span class="keyword">then</span></span><br><span class="line">                _class.ctor(_newInstance, ...)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">create</span>(NewClass, ...)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">setmetatable</span>(_newInstance, &#123;<span class="built_in">__index</span> = NewClassMetatableCore&#125;)</span><br><span class="line">    <span class="keyword">return</span> _newInstance</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>前半部分应该很好理解,就是一直递归到根Class然后逐层调用ctor. 有问题的其实是 看似平常的</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setmetatable</span>(_newInstance, &#123;<span class="built_in">__index</span> = NewClassMetatableCore&#125;)</span><br></pre></td></tr></table></figure>
<p>这已经是被我翻译过一次的了,原始的代码是</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setmetatable</span>(obj,&#123; <span class="built_in">__index</span>=_class[class_type] &#125;)</span><br></pre></td></tr></table></figure>
<p>然后<code>_class</code>和<code>class_type</code>的定义均在前面.</p>
<p>还是回到我的low版代码吧,</p>
<p>需要注意的是 <code>setmetatable(x, {__index = y})</code>这种写法我<a href="http://oldking.wang/fe8c5fe0-ae96-11e8-abfb-e54ee4891837/" target="_blank" rel="noopener">之前</a>有提过, 就是真大哥假大哥的问题</p>
<p>同时,此处相比于<code>Quick</code>代码中</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newClass.new</span><span class="params">(...)</span></span></span><br><span class="line">        <span class="keyword">local</span> instance = &#123;&#125;</span><br><span class="line">        <span class="built_in">setmetatable</span>(instance, newClass)</span><br><span class="line">        instance.class = newClass</span><br><span class="line">        instance:ctor(...)</span><br><span class="line">        <span class="keyword">return</span> instance</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>直接把<code>instance</code>和<code>class</code>进行绑定, 风神是吧<code>instance</code>和<code>NewClassMetatableCore</code>进行了绑定,(我特意起了一个比较诡异的名字,方便理解). </p>
<p>因为这部分没法单独说,所以暂时让我们先跳过<code>new</code>函数分析,看一下<code>newClass</code>的实现</p>
<h4 id="class-定义部分"><a href="#class-定义部分" class="headerlink" title="class 定义部分"></a>class 定义部分</h4><p>这部分分成两块,就是有<code>super</code>和没<code>super</code>的.</p>
<h5 id="基类Class"><a href="#基类Class" class="headerlink" title="基类Class"></a>基类Class</h5><p>先让我们来看没有Super的,就是例子中的<code>AnimalClass</code>.</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setmetatable</span>(NewClass, &#123;<span class="built_in">__newindex</span> =</span><br><span class="line">       <span class="function"><span class="keyword">function</span><span class="params">(t, k, v)</span></span></span><br><span class="line">           NewClassMetatableCore[k] = v</span><br><span class="line">       <span class="keyword">end</span></span><br><span class="line">   &#125;)</span><br></pre></td></tr></table></figure>
<p>带入例子,这里面的<code>NewClass</code>就是对应的<code>AnimalClass</code>,而这段代码的意思呢 就是说 在往<code>AnimalClass</code>这张Table上添加任何key,vlaue时候呢 都通通给我添加到<code>NewClassMetatableCore</code>上来.</p>
<p>所以当后面我们去写<code>Animal.lua</code>文件</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AnimalClass:SayHI</span><span class="params">(_msg)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"Animal %s say hi with msg : %s"</span>, self.mName, _msg))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AnimalClass:Eat</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"Animal %s eat with food : %s"</span>, self.mName, self:GetEatFood()))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这些函数 其实没有任何一条是写在<code>AnimalClass</code>这张table上的</p>
<h5 id="子类"><a href="#子类" class="headerlink" title="子类"></a>子类</h5><p>那<code>AnimalClass</code>怎么理解的, 我是把这个当做 “钥匙” 来理解的,并且还不是对自己,而是相对于<code>CatClass</code></p>
<p>来看有<code>super</code>部分的代码实现</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> superFromArg <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">setmetatable</span>(NewClassMetatableCore, &#123;<span class="built_in">__index</span> =</span><br><span class="line">        <span class="function"><span class="keyword">function</span><span class="params">(t, k)</span></span></span><br><span class="line">            <span class="keyword">local</span> ret = mAllClassMetatableCoreCache[superFromArg][k]</span><br><span class="line">            NewClassMetatableCore[k] = ret</span><br><span class="line">            <span class="keyword">return</span> ret</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    &#125;)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这个代码的意思呢,就是给 <code>NewClassMetatableCore</code> 绑定了 一个大哥,这个大哥呢还和之前的例子不同,不是一个不干事儿的大哥 而是一段方法.</p>
<p>这段代码 直接看有点绕, 让我们直接带入例子来看 这段时怎么工作的吧</p>
<p>首先拿出之前例子的中小c(c1)</p>
<p>c1是一个对象了 c1的真大哥呢 是 <code>setmetatable(_newInstance, {__index = NewClassMetatableCore})</code>中的<code>{__index = NewClassMetatableCore}</code></p>
<p>把Cat带入就是 <code>cat真大哥={__index = CatClassMetatableCore}</code> , <code>cat假大哥= CatClassMetatableCore</code></p>
<p>首先我们知道,当写<code>Cat.lua</code>时候</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CatClass:SayHI</span><span class="params">(_msg)</span></span></span><br><span class="line">    <span class="comment">--CatClass.super.SayHI(self, _msg)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[Override] CatClass called"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CatClass:GetEatFood</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Fish"</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>我们把<code>SayHI</code>和<code>GetEatFood</code>两个方法写到 这个<code>cat假大哥</code>身上了. 但是我们没有写<code>Eat</code>这个方法. 所以当调用</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c1:Eat()</span><br></pre></td></tr></table></figure>
<p>首先c1先懵圈 不知道Eat是啥 然后他就去问他的 <code>cat真大哥</code>,真大哥打手一指 就让 小c 去他的<code>cat假大哥</code>身上找去.</p>
<p><code>cat假大哥</code> 一听要找<code>Eat</code> 自己也不知道怎么整啊!  不过此时突然想起来了,自己是有<code>super</code>这个key的,所以定义的时候上帝也给自己找了一个大哥的!</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> superFromArg <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">setmetatable</span>(NewClassMetatableCore, &#123;<span class="built_in">__index</span> =</span><br><span class="line">        <span class="function"><span class="keyword">function</span><span class="params">(t, k)</span></span></span><br><span class="line">            <span class="keyword">local</span> ret = mAllClassMetatableCoreCache[superFromArg][k]</span><br><span class="line">            NewClassMetatableCore[k] = ret</span><br><span class="line">            <span class="keyword">return</span> ret</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    &#125;)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>翻译一下上面的代码就是</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">local</span> cat假大哥的大哥 = &#123;&#125;</span><br><span class="line">cat假大哥的大哥.<span class="built_in">__index</span> = 一个查询方法</span><br><span class="line"></span><br><span class="line"><span class="built_in">setmetatable</span>(cat假大哥的大哥,cat假大哥的大哥)</span><br></pre></td></tr></table></figure>
<p>我特意把里面的<code>key</code>换成了<code>superFromArg</code>,因为这块非常容易和自己身上的<code>super</code>key混淆.  这个<code>查询方法</code>直接取得是类定义时候的<code>superFromArg</code>(closure闭包),和<code>cat假大哥</code>没有什么关系的,</p>
<p><code>cat假大哥</code>看到的 就是一个普通方法而已</p>
<p>继续上面的分析就是,<code>cat假大哥</code>通过这个查询方法 找到了<code>Eat</code>这玩意,然后一路递归返回给<code>小C</code>,<code>小C</code>拿着Eat就去自己愉快的玩耍了.</p>
<p>注意这个<code>查询方法</code>里面有一行是</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NewClassMetatableCore[k] = ret</span><br></pre></td></tr></table></figure>
<p>这也就是风神自己博客下方有个兄弟留言说的<code>Write On Use</code>. 也就是 小C 第二次访问Eat操作时候,<code>cat假大哥</code>就知道<code>Eat</code>了,不会再通过<code>查询方法</code>从<code>mAllClassMetatableCoreCache</code>这个大Table中进行查询了.</p>
<h2 id="CatClass-super-SayHI-self-msg-问题"><a href="#CatClass-super-SayHI-self-msg-问题" class="headerlink" title="CatClass.super.SayHI(self, _msg) 问题"></a>CatClass.super.SayHI(self, _msg) 问题</h2><p>在<code>Quick</code>版本中这行是可以执行的,也就是子类Override了父类,然后还要调用父类的这个方法. 这个调用方式在风神的版本中不能这样实现.</p>
<p>有意思的是,我无意中<code>Google</code>还<code>Google</code>到一位大作家尝试着解决这个问题呢! </p>
<p>大作家也是个神人 先是在第一篇文章中云里来雾里去的分析了一通,然后因为所以科学道理 就直接得出了一些 很奇怪的 结论. 接着又在第二篇文章里面指出了这个无法调用Super的问题. 接着给出一个大作家版的实现.</p>
<p>抛开作家不说,底下有位仁兄应该也是遇到了这个问题, 然后给出了一个 <a href="https://blog.csdn.net/yxriyin/article/details/78923257" target="_blank" rel="noopener">他自己的递归解决法</a></p>
<p>其实风神这版实现是可以完成调用Super的,方法如下:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CatClass:SayHI</span><span class="params">(_msg)</span></span></span><br><span class="line"> 	<span class="built_in">print</span>(<span class="string">"[Override] CatClass start"</span>)</span><br><span class="line">	<span class="keyword">local</span> mtCat =<span class="built_in">getmetatable</span>(self).<span class="built_in">__index</span></span><br><span class="line">	<span class="keyword">local</span> mtCatMt =<span class="built_in">getmetatable</span>(mtCat)</span><br><span class="line">	<span class="keyword">local</span> superF = mtCatMt.<span class="built_in">__index</span>(<span class="literal">nil</span>,<span class="string">"SayHI"</span>)</span><br><span class="line">	superF(self,_msg)</span><br><span class="line">  <span class="comment">--CatClass.super.SayHI(self, _msg)</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"[Override] CatClass called"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>用这个方法替换原来<code>Cat</code>的SayHI实现即可. 具体为啥这样写可以 ,我也学下大作家好了. </p>
<blockquote>
<p>这个道理很简单,请读者自行思考一下即可. 来接着听我忽悠别的. 😂</p>
</blockquote>
<p>anyway,我觉得如果有兴趣你可以自己尝试一下 为何这样写可以. 如果能推出来 说明我上面忽悠的那一堆还是有些用处的😎.</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>风神这个OOP实现 对我来说最大的收获 就好比上学时候做对了卷子最后的附加题😂  让我对Lua似乎又明白了一些. 恩 恬不知耻的说 似乎感觉自己是 从入门到入了门…</p>
<p>至于代码层面上来说,相比Quick版 功能上多实现了一个<code>Write On Use</code>,然后构造函数是自动递归下去执行的 无需手动调用了. 不过这部分在Quick版本的代码中是比较好改造的. 详情参见<a href="905e8b50-ae97-11e8-980c-c39a9b9cf992">我自己改造的版本</a></p>
<p>其他的 感觉就是将Class的Metatable藏得更深了一些,不过这么做的好处 我这个还在上学前班的小学童 目前还无法get到.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.oldking.wang/91a7d430-ae97-11e8-8886-2901af87d97e/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/91a7d430-ae97-11e8-8886-2901af87d97e/" itemprop="url">Lua从入门到入了门(4) OOP深入分析之QuickX版</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-02T18:00:04+08:00">
                2018-09-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="原始实现"><a href="#原始实现" class="headerlink" title="原始实现"></a>原始实现</h2><p><a href="https://github.com/chukong/quick-cocos2d-x/blob/master/framework/functions.lua" target="_blank" rel="noopener">quick-cocos2d-x版</a></p>
<p>在<code>functions.lua</code>函数281行开始 给出了<code>class</code>的实现方式</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">class</span><span class="params">(classname, super)</span></span></span><br><span class="line">    <span class="keyword">local</span> superType = <span class="built_in">type</span>(super)</span><br><span class="line">    <span class="keyword">local</span> cls</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> superType ~= <span class="string">"function"</span> <span class="keyword">and</span> superType ~= <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">        superType = <span class="literal">nil</span></span><br><span class="line">        super = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> superType == <span class="string">"function"</span> <span class="keyword">or</span> (super <span class="keyword">and</span> super.__ctype == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- inherited from native C++ Object</span></span><br><span class="line">        cls = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> superType == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">            <span class="comment">-- copy fields from super</span></span><br><span class="line">            <span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">pairs</span>(super) <span class="keyword">do</span> cls[k] = v <span class="keyword">end</span></span><br><span class="line">            cls.__create = super.__create</span><br><span class="line">            cls.super    = super</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            cls.__create = super</span><br><span class="line">            cls.ctor = <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        cls.__cname = classname</span><br><span class="line">        cls.__ctype = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">cls.new</span><span class="params">(...)</span></span></span><br><span class="line">            <span class="keyword">local</span> instance = cls.__create(...)</span><br><span class="line">            <span class="comment">-- copy fields from class to native object</span></span><br><span class="line">            <span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">pairs</span>(cls) <span class="keyword">do</span> instance[k] = v <span class="keyword">end</span></span><br><span class="line">            instance.class = cls</span><br><span class="line">            instance:ctor(...)</span><br><span class="line">            <span class="keyword">return</span> instance</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">-- inherited from Lua Object</span></span><br><span class="line">        <span class="keyword">if</span> super <span class="keyword">then</span></span><br><span class="line">            cls = &#123;&#125;</span><br><span class="line">            <span class="built_in">setmetatable</span>(cls, &#123;<span class="built_in">__index</span> = super&#125;)</span><br><span class="line">            cls.super = super</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            cls = &#123;ctor = <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>&#125;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        cls.__cname = classname</span><br><span class="line">        cls.__ctype = <span class="number">2</span> <span class="comment">-- lua</span></span><br><span class="line">        cls.<span class="built_in">__index</span> = cls</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">cls.new</span><span class="params">(...)</span></span></span><br><span class="line">            <span class="keyword">local</span> instance = <span class="built_in">setmetatable</span>(&#123;&#125;, cls)</span><br><span class="line">            instance.class = cls</span><br><span class="line">            instance:ctor(...)</span><br><span class="line">            <span class="keyword">return</span> instance</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cls</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>将如上函数保存为<code>ClassQ.lua</code></p>
<p>再创建如下文件</p>
<p><code>Animal.lua</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">AnimalClass = class(<span class="string">"AnimalClass"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AnimalClass:ctor</span><span class="params">(_name)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"call animal ctor name is: "</span>.._name)</span><br><span class="line">    self.mName = _name</span><br><span class="line">    self.mFood = <span class="string">"normal food"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AnimalClass:SayHI</span><span class="params">(_msg)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"Animal %s say hi with msg : %s"</span>, self.mName, _msg))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AnimalClass:Eat</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"Animal %s eat with food : %s"</span>, self.mName, self:GetEatFood()))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AnimalClass:GetEatFood</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> self.mFood</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><code>Cat.lua</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CatClass = class(<span class="string">"CatClass"</span>,AnimalClass)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CatClass:ctor</span><span class="params">(_name, _color)</span></span></span><br><span class="line">    CatClass.super.ctor(self, _name)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"call cat ctor name is: %s color is %s"</span>, _name, _color))</span><br><span class="line">    self.mColor = _color</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CatClass:SayHI</span><span class="params">(_msg)</span></span></span><br><span class="line">    CatClass.super.SayHI(self, _msg)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[Override] CatClass called"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CatClass:GetEatFood</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Fish"</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>入口文件<code>main.lua</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">"ClassQ"</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"Animal"</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"Cat"</span>)</span><br><span class="line"></span><br><span class="line">a1 = AnimalClass.new(<span class="string">"A1"</span>)</span><br><span class="line">a1:SayHI(<span class="string">"oh~"</span>)</span><br><span class="line">a1:Eat()</span><br><span class="line"></span><br><span class="line">c1 = CatClass.new(<span class="string">"C1"</span>,<span class="string">"Red"</span>)</span><br><span class="line">c1:SayHI(<span class="string">"oh~"</span>)</span><br><span class="line">c1:Eat()</span><br></pre></td></tr></table></figure>
<p>输出结果为:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">call animal ctor name is: A1</span><br><span class="line">Animal A1 say hi with msg : oh~</span><br><span class="line">Animal A1 eat with food : normal food</span><br><span class="line"></span><br><span class="line">call animal ctor name is: C1</span><br><span class="line">call cat ctor name is: C1 color is Red</span><br><span class="line"></span><br><span class="line">Animal C1 say hi with msg : oh~</span><br><span class="line">[Override] CatClass called</span><br><span class="line"></span><br><span class="line">Animal C1 eat with food : Fish</span><br></pre></td></tr></table></figure>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="删减"><a href="#删减" class="headerlink" title="删减"></a>删减</h3><p><code>QuickX</code>有一部分是为了要考虑直接和引擎C++层绑定,这部分不在我们的讨论范围中. 所以将其class函数中相关部分代码去掉.</p>
<p>最终代码为:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">class</span><span class="params">(classname, super)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> cls</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- inherited from Lua Object</span></span><br><span class="line">    <span class="keyword">if</span> super <span class="keyword">then</span></span><br><span class="line">        cls = &#123;&#125;</span><br><span class="line">        <span class="built_in">setmetatable</span>(cls, &#123;<span class="built_in">__index</span> = super&#125;)</span><br><span class="line">        cls.super = super</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        cls = &#123;ctor = <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>&#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    cls.__cname = classname</span><br><span class="line">    cls.<span class="built_in">__index</span> = cls</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">cls.new</span><span class="params">(...)</span></span></span><br><span class="line">        <span class="keyword">local</span> instance = <span class="built_in">setmetatable</span>(&#123;&#125;, cls)</span><br><span class="line">        instance.class = cls</span><br><span class="line">        instance:ctor(...)</span><br><span class="line">        <span class="keyword">return</span> instance</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> cls</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="等效转换"><a href="#等效转换" class="headerlink" title="等效转换"></a>等效转换</h3><p>接着和之前一样 我们再把这部分代码 改些名字,去除个语法糖  <strong>等效</strong> 的改成如下代码:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">class</span><span class="params">(classname, super)</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">local</span> newClass</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- inherited from Lua Object</span></span><br><span class="line">    <span class="keyword">if</span> super <span class="keyword">then</span></span><br><span class="line">        newClass = &#123;&#125;</span><br><span class="line">        <span class="built_in">setmetatable</span>(newClass, &#123;<span class="built_in">__index</span> = super&#125;)</span><br><span class="line">        newClass.super = super</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        newClass = &#123;ctor = <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>&#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    newClass.__cname = classname</span><br><span class="line">    newClass.<span class="built_in">__index</span> = newClass</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">newClass.new</span><span class="params">(...)</span></span></span><br><span class="line">        <span class="keyword">local</span> instance = &#123;&#125;</span><br><span class="line">        <span class="built_in">setmetatable</span>(instance, newClass)</span><br><span class="line">        instance.class = newClass</span><br><span class="line">        instance:ctor(...)</span><br><span class="line">        <span class="keyword">return</span> instance</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> newClass</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="拆解分析"><a href="#拆解分析" class="headerlink" title="拆解分析"></a>拆解分析</h3><h4 id="事先了解"><a href="#事先了解" class="headerlink" title="事先了解"></a>事先了解</h4><blockquote>
<p> 如果你对为何能等效转换及2B情景法有疑问,请看我之前的文章: <a href="http://oldking.wang/fe8c5fe0-ae96-11e8-abfb-e54ee4891837/" target="_blank" rel="noopener">Lua从入门到入了门(2) 基础难点概述</a></p>
</blockquote>
<h4 id="new-函数"><a href="#new-函数" class="headerlink" title="new 函数"></a>new 函数</h4><p>首先要拆开了来看, 先看new函数部分</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">--函数定义</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newClass.new</span><span class="params">(...)</span></span></span><br><span class="line">        <span class="keyword">local</span> instance = &#123;&#125;</span><br><span class="line">        <span class="built_in">setmetatable</span>(instance, newClass)</span><br><span class="line">        instance.class = newClass</span><br><span class="line">        instance:ctor(...)</span><br><span class="line">        <span class="keyword">return</span> instance</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--调用方法</span></span><br><span class="line">a1 = AnimalClass.new(<span class="string">"A1"</span>)</span><br><span class="line">c1 = CatClass.new(<span class="string">"C1"</span>,<span class="string">"Red"</span>)</span><br></pre></td></tr></table></figure>
<p>这部分很简答, 就是把小弟和大哥关联了一下. 顺便调用了一下小弟的<code>ctor</code>函数 让其初始化以下.</p>
<h4 id="class-定义部分"><a href="#class-定义部分" class="headerlink" title="class 定义部分"></a>class 定义部分</h4><p>比较绕的是class定义部分</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">--函数定义</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">class</span><span class="params">(classname, super)</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">local</span> newClass</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- inherited from Lua Object</span></span><br><span class="line">    <span class="keyword">if</span> super <span class="keyword">then</span></span><br><span class="line">        newClass = &#123;&#125;</span><br><span class="line">        <span class="built_in">setmetatable</span>(newClass, &#123;<span class="built_in">__index</span> = super&#125;)</span><br><span class="line">        newClass.super = super</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        newClass = &#123;ctor = <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>&#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    newClass.__cname = classname</span><br><span class="line">    newClass.<span class="built_in">__index</span> = newClass</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> newClass</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--调用方法</span></span><br><span class="line"></span><br><span class="line">AnimalClass = class(<span class="string">"AnimalClass"</span>)</span><br><span class="line">CatClass = class(<span class="string">"CatClass"</span>,AnimalClass)</span><br></pre></td></tr></table></figure>
<h5 id="AnimalClass"><a href="#AnimalClass" class="headerlink" title="AnimalClass"></a>AnimalClass</h5><p>定义小a的大哥<code>AnimalClass</code>时候,大哥就是一个含有ctor函数的空表,注意此时<code>AnimalClass</code>还不是小a的大哥,只是一张普通的table而已. 所以</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">newClass.<span class="built_in">__index</span> = newClass</span><br></pre></td></tr></table></figure>
<p>这行定义 只是找了一个名字叫<code>__index</code>的Key,让其值又引用了其自身, 只有当创建小a时候</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a1 = AnimalClass.new(<span class="string">"A1"</span>)</span><br></pre></td></tr></table></figure>
<p>此时<code>AnimalClass</code>才成了小a的大哥,<code>AnimalClass.__index=AnimalClass</code>才等效与之前例子中的<code>GreenPaper</code>(在之前的教程中)</p>
<h5 id="CatClass"><a href="#CatClass" class="headerlink" title="CatClass"></a>CatClass</h5><p><code>CatClass</code>有别与<code>AnimalClass</code>,定义时候是有super的. 所以就是相当于 设置了 大哥的大哥.</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">--调用这行</span></span><br><span class="line">CatClass = class(<span class="string">"CatClass"</span>,AnimalClass)</span><br><span class="line"><span class="comment">--带入则变为</span></span><br><span class="line"><span class="built_in">setmetatable</span>(CatClass, &#123;<span class="built_in">__index</span> = AnimalClass&#125;)</span><br></pre></td></tr></table></figure>
<p>所以当小c(c1) 调用某个函数时候 首先问其大哥<code>CatClass</code>,</p>
<blockquote>
<p>c1其实只包含了数据,都是 通过 <code>self.mColor=xxx</code> 这种在某些函数中定义的,自身是不包含任何函数的. 所以外面一调用<code>c1:SayHI()</code> 这种函数 <code>c1</code>中肯定是没有的,所以就会去向其大哥求救</p>
</blockquote>
<p>大哥查了一下自己发现自己也搞不定</p>
<blockquote>
<p>大哥之所以会查自己,是因为上面<code>newClass.__index = newClass</code>设置的,大哥自己能搞得定的情况就是说明子类Override了父类的方法了.也就是大哥中有这个实现. 比如例子中的<code>CatClass:SayHI</code>. 没有实现的 比如<code>CatClass:Eat</code> 就是大哥自己也搞不定的情况了.</p>
</blockquote>
<p>大哥(CatClass)搞不定就去问了其大哥的大哥<code>AnimalClass</code></p>
<blockquote>
<p><code>CatClass</code>会去问<code>AnimalClass</code> 是因为设置了<code>setmetatable(newClass, {__index = super})</code> , 这部分有点绕 涉及到点有几个</p>
<ol>
<li><p><code>CatClass</code>是c1的元表,但是其自身也是表,他也是可以有元表的</p>
</li>
<li><p><code>CatClass</code>的元表 并不是 <code>AnimalClass</code> 😎 惊不惊喜?意不意外? 详情可以看我之前的文章, 就是真大哥,假大哥那块.</p>
</li>
<li><p><code>CatClass</code>只有自己查不到的情况下才会向<code>AnimalClass</code>求救的. 这也是我之前一直比较懵圈的地方. 用2B情景法来描述就是</p>
</li>
</ol>
<p>小弟(c1)先自己解决,解决不了找大哥(CatClass)<br>小弟(CatClass)先自己解决,解决不了找大哥(AnimalClass)</p>
<p>这样一层一层就递归下去了</p>
</blockquote>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>Quick这个实现版本基本上来说已经够用了,不过调用时候有几个点要注意</p>
<h3 id="new函数需要用-的方式来调用-其他函数却需要用-来调用"><a href="#new函数需要用-的方式来调用-其他函数却需要用-来调用" class="headerlink" title="new函数需要用 .的方式来调用,其他函数却需要用:来调用"></a>new函数需要用 <code>.</code>的方式来调用,其他函数却需要用<code>:</code>来调用</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">--正确的</span></span><br><span class="line">a1 = AnimalClass.new(<span class="string">"A1"</span>) </span><br><span class="line"><span class="comment">--错误的</span></span><br><span class="line">a1 = AnimalClass:new(<span class="string">"A1"</span>)</span><br></pre></td></tr></table></figure>
<p>原因是因为其new函数声明时候用的点,内部instance用的是冒号,这样用冒号去调用new函数时候会多往ctor中传一个”self”(这个self其实是Class)</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">a1 = AnimalClass:new(<span class="string">"A1"</span>)</span><br><span class="line"><span class="comment">--等阶与</span></span><br><span class="line">a1 = AnimalClass.new(AnimalClass,<span class="string">"A1"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--new函数内部调用</span></span><br><span class="line">instance:ctor(...)</span><br><span class="line"><span class="comment">--等阶与</span></span><br><span class="line">instance.ctor(instance,...)</span><br><span class="line"></span><br><span class="line"><span class="comment">--带入上面的a1和实际参数则为</span></span><br><span class="line">a1.ctor(a1,AnimalClass,<span class="string">"A1"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--但是Animal的ctor定义为</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AnimalClass:ctor</span><span class="params">(_name)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">--所以用AnimalClass:new("A1")调用的话 _name得到的是AnimalClass,"A1"这个参数就丢失了</span></span><br></pre></td></tr></table></figure>
<h3 id="可以实现子类重载后还能调用父类的方法只不过实现起来看着会比较诡异"><a href="#可以实现子类重载后还能调用父类的方法只不过实现起来看着会比较诡异" class="headerlink" title="可以实现子类重载后还能调用父类的方法只不过实现起来看着会比较诡异"></a>可以实现子类重载后还能调用父类的方法只不过实现起来看着会比较诡异</h3><p>比如<code>Cat</code>中的SayHI函数</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CatClass<span class="selector-class">.super</span><span class="selector-class">.SayHI</span>(self, _msg)</span><br></pre></td></tr></table></figure>
<p>理解起来其实倒是不难, <code>CatClass.super</code> 也就是 <code>AnimalClass</code></p>
<p>也就变成了 </p>
<p><code>AnimalClass.SayHI(self, _msg)</code></p>
<p>此时self是<code>c1</code> , 不能直接 <code>AnimalClass:SayHI(_msg)</code> ,因为这样就没把<code>c1</code>传过去. 相当于表儿传错了</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.oldking.wang/001ee6c0-ae97-11e8-ac40-db55252f3df1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/001ee6c0-ae97-11e8-ac40-db55252f3df1/" itemprop="url">Lua从入门到入了门(3) OOP深入分析之教科书版</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-02T18:00:03+08:00">
                2018-09-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="原始实现"><a href="#原始实现" class="headerlink" title="原始实现"></a>原始实现</h2><p><a href="http://www.lua.org/pil/16.2.html" target="_blank" rel="noopener">源代码地址http://www.lua.org/pil/16.2.html</a></p>
<p>我做了些许改变,代码如下:</p>
<p>Account.lua文件</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Account = &#123;balance = <span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Account:new</span> <span class="params">(o)</span></span></span><br><span class="line">    o = o <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(o, self)</span><br><span class="line">    self.<span class="built_in">__index</span> = self</span><br><span class="line">    <span class="keyword">return</span> o</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Account:deposit</span> <span class="params">(v)</span></span></span><br><span class="line">    self.balance = self.balance + v</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Account:withdraw</span> <span class="params">(v)</span></span></span><br><span class="line">    <span class="keyword">if</span> v &gt; self.balance <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"你没那么多钱 取不出来的 兄弟"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    self.balance = self.balance - v</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>SpecialAccount.lua文件</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SpecialAccount = Account:new()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SpecialAccount:withdraw</span> <span class="params">(v)</span></span></span><br><span class="line">    <span class="keyword">if</span> v - self.balance &gt;= self:getLimit() <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">error</span><span class="string">"insufficient funds"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    self.balance = self.balance - v</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SpecialAccount:getLimit</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> self.limit <span class="keyword">or</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>入口文件</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">"Account"</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"SpecialAccount"</span>)</span><br><span class="line"></span><br><span class="line">normalAccount = Account:new()</span><br><span class="line">normalAccount:deposit(<span class="number">100.00</span>)</span><br><span class="line">normalAccount:withdraw(<span class="number">300</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"普通账户当前存款: "</span>..normalAccount.balance)</span><br><span class="line"></span><br><span class="line">sAccount = SpecialAccount:new&#123;limit = <span class="number">1000.00</span>&#125;</span><br><span class="line">sAccount:deposit(<span class="number">100.00</span>)</span><br><span class="line">sAccount:withdraw(<span class="number">300</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"特殊账户当前存款: "</span>..sAccount.balance)</span><br></pre></td></tr></table></figure>
<p>输出结果:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">你没那么多钱 取不出来的 兄弟</span><br><span class="line">普通账户当前存款: <span class="number">100.0</span></span><br><span class="line"></span><br><span class="line">特殊账户当前存款: <span class="number">-200.0</span></span><br></pre></td></tr></table></figure>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>OOP核心部分实现代码就是这块:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Account:new</span> <span class="params">(o)</span></span></span><br><span class="line">    o = o <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(o, self)</span><br><span class="line">    self.<span class="built_in">__index</span> = self</span><br><span class="line">    <span class="keyword">return</span> o</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--外部调用方法</span></span><br><span class="line"></span><br><span class="line">normalAccount = Account:new()</span><br></pre></td></tr></table></figure>
<p>直接去除语法糖,更换变量名 将上面代码  <strong>等效</strong>  转化为 如下代码:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Account.new = <span class="function"><span class="keyword">function</span> <span class="params">(_firstArg, _newTable)</span></span></span><br><span class="line">    _newTable = _newTable <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(_newTable, _firstArg)</span><br><span class="line">    _firstArg.<span class="built_in">__index</span> = _firstArg</span><br><span class="line">    <span class="keyword">return</span> _newTable</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--外部调用方法</span></span><br><span class="line"></span><br><span class="line">normalAccount = Account.new(Account)</span><br></pre></td></tr></table></figure>
<p> 如果你对为何能等效转换及2B情景法有疑问,请看我之前的文章: <a href="http://oldking.wang/fe8c5fe0-ae96-11e8-abfb-e54ee4891837/" target="_blank" rel="noopener">Lua从入门到入了门(2) 基础难点概述</a></p>
<p>然后让我用2B情景法翻译一下上面那段</p>
<p><code>_newTable</code>就是小弟,<code>_firstArg</code>也就是调用时候传入的<code>Account</code>就是大哥</p>
<p><code>setmetatable(_newTable, _firstArg)</code> 让小弟认了大哥</p>
<p><code>_firstArg.__index = _firstArg</code> 大哥偷懒,直接将查找函数指向了自己,(参考之前例子中GreenPaper)</p>
<p>然后直接return 了小弟, 小弟就可以自己去愉快的玩耍了.</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>教科书给出的OOP模拟方式是最好理解的,但是相应的会在编写上稍显复杂. 比如 <code>SpecialAccount</code>声明时候要去写 <code>SpecialAccount = Account:new()</code></p>
<p>所以这个例子更多的是教学意义大于实际意义</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.oldking.wang/fe8c5fe0-ae96-11e8-abfb-e54ee4891837/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/fe8c5fe0-ae96-11e8-abfb-e54ee4891837/" itemprop="url">Lua从入门到入了门(2) 基础难点概述</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-02T18:00:02+08:00">
                2018-09-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="如何组织代码"><a href="#如何组织代码" class="headerlink" title="如何组织代码"></a>如何组织代码</h2><p>Lua和JS一样都是<code>解释型语言</code>,没有入口的概念. 但是要实现文章1结尾时候所说的Coding环境</p>
<blockquote>
<p>写个入口文件 <code>main.lua</code> 然后每个类一个文件 从入口文件的某个函数开始执行 然后把整个程序Run起来</p>
</blockquote>
<p>我能想到的解决方案是</p>
<ol>
<li><p>首先通过某种方法可以用Lua模拟出类的概念</p>
</li>
<li><p>将每一个类都单独建立一个<code>*.lua</code>文件</p>
</li>
<li><p>建立一个<code>Load.lua</code>和<code>Main.lua</code>文件(Main.lua也是模拟出来的类),<code>Main</code>类里面有一个<code>Start()</code>方法</p>
</li>
<li><p>在<code>Load.lua</code>中通过<code>require</code>函数将其余所有的文件都require进来,然后new一个Main的对象执行<code>Start()</code>方法 开始整个程序</p>
</li>
</ol>
<p>伪码如下:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">"ClassA"</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"ClassB"</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"ClassC"</span>)</span><br><span class="line">...</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"ClassY"</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"ClassZ"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--都require完了以后执行:</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> entry = Main.new();</span><br><span class="line">entry.Start();</span><br></pre></td></tr></table></figure>
<h3 id="实际项目"><a href="#实际项目" class="headerlink" title="实际项目"></a>实际项目</h3><p>因为没和其他人交流过 也不知道 这是不是个标准流程 ,不过我自己的项目是准备这么弄的. </p>
<p>会有一些改动 因为有部分代码应该会直接和<code>GameObject</code>做双向绑定,所以不一定入口文件需要将所有文件都<code>require</code>进来,并且入口文件也不一定会只有一个.</p>
<p>另外一个就是<code>Load.lua</code>这个文件到时候应该会根据某种配置用程序生成. </p>
<p>比如<code>Lua/InitLoad/*.lua</code>下面的文件都初始时候加载,然后<code>Lua/Manual/*.lua</code>下面的文件都手动加载.  </p>
<p>或者直接用前缀做区分 <code>Init_$ClassName.lua</code>,<code>Manual_$ClassName.lua</code></p>
<p>但是大体上来说,结构会按照上面所说的那样.</p>
<h3 id="require-中-local的作用域"><a href="#require-中-local的作用域" class="headerlink" title="require 中 local的作用域"></a>require 中 local的作用域</h3><p>这是我当时有些没搞懂的地方,就是local 变量作用域的问题. 一个local变量 放在一个for循环里面,或者放在一个函数里面 都很好理解. 因为和其他语言都相同嘛. 就是局部变量的概念.</p>
<p>但是这个<code>require</code>是怎么个意思? 我当时就是以为<code>require</code>就是横向拆分</p>
<p>比如我就一个<code>Main.lua</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> A = <span class="string">"A"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"A is: "</span>..A)</span><br></pre></td></tr></table></figure>
<p>输出结果肯定就是</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">A</span> is: <span class="keyword">A</span></span><br></pre></td></tr></table></figure>
<p>此时我把<code>local A = &quot;A&quot;</code>放到另外一个文件<code>ClassA.lua</code>中 然后执行</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">require</span><span class="params">(<span class="string">"ClassA"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="string">"A is: "</span>..A)</span></span></span><br></pre></td></tr></table></figure>
<p>运行会报错</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lua: main.lua:<span class="number">4</span>: attempt to concatenate a <span class="literal">nil</span> value (global <span class="string">'A'</span>)</span><br></pre></td></tr></table></figure>
<p>我大概看了一下<code>require</code>的伪实现代码,应该是内部通过一个Loader进行加载,然后缓存到<code>package.loaded</code>中来.所以是否可以理解为</p>
<blockquote>
<p>整个<code>require</code>到的”文件”都是在这个Load函数的作用域中(closure闭包)?</p>
</blockquote>
<p>不过 无论具体实现如何 我目前就把<code>require</code>当做放在了一个<code>do end</code>的代码块中来理解了</p>
<p>伪码如下:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--require("ClassA")转意为:</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> A = <span class="string">"A"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--Main.lua</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"A is: "</span>..A)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="看懵圈的语法"><a href="#看懵圈的语法" class="headerlink" title="看懵圈的语法"></a>看懵圈的语法</h2><p>Lua内有一些语法糖(Syntactic sugar),还有一些内置的关键key. 所以初接触时候比较晕, 虽然都有所了解 但是开始时理解的还是不够深入. 就像上学时候学习新公式似的. 讲完都会 一放到具体习题里面又都懵圈了.</p>
<h3 id="function"><a href="#function" class="headerlink" title="function"></a>function</h3><h4 id="function-中的-name"><a href="#function-中的-name" class="headerlink" title="function 中的 name"></a>function 中的 name</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Fun1=<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">"Fun1 called"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Fun2</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">"Fun2 called"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Fun1();</span><br><span class="line">Fun2();</span><br><span class="line"></span><br><span class="line">Wrap=&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Wrap.WFun1</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">"Wrap Fun1 called"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Wrap.WFun2=<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">"Wrap Fun2 called"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Wrap[<span class="string">"WFun1"</span>]()</span><br><span class="line">Wrap.WFun2();</span><br></pre></td></tr></table></figure>
<p>Lua中函数均为<strong>匿名函数</strong>,所以Fun2就可以理解为在全局声明了一个叫Fun2的变量,其引用了一个匿名函数,</p>
<p>同理的,<code>Wrap.WFun1</code> 就是在Wrap这个<code>table</code>中用一个WFun1作为一个Key 引用了一个匿名函数.</p>
<h4 id="function-中的"><a href="#function-中的" class="headerlink" title="function 中的 :"></a>function 中的 :</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Wrap=&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Wrap:WFun3</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">"Self is a "</span>,self);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Wrap.WFun4=<span class="function"><span class="keyword">function</span><span class="params">(_firstArg)</span></span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">"First also is a "</span>,_firstArg);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Wrap.WFun3(Wrap)</span><br><span class="line">Wrap:WFun3()</span><br><span class="line"></span><br><span class="line">Wrap.WFun4(Wrap)</span><br><span class="line">Wrap:WFun4(Wrap)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> AnotherWrap = &#123;&#125;</span><br><span class="line">AnotherWrap.HoldKey=Wrap;</span><br><span class="line"></span><br><span class="line">Wrap.WFun3(AnotherWrap)</span><br><span class="line">AnotherWrap.HoldKey:WFun3()</span><br></pre></td></tr></table></figure>
<p>上面函数调用的输出结果为:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Self is a 	<span class="built_in">table</span>: <span class="number">0x7f8353c068f0</span></span><br><span class="line">Self is a 	<span class="built_in">table</span>: <span class="number">0x7f8353c068f0</span></span><br><span class="line">First also is a <span class="built_in">table</span>: <span class="number">0x7f8353c068f0</span></span><br><span class="line">First also is a <span class="built_in">table</span>: <span class="number">0x7f8353c068f0</span></span><br><span class="line"></span><br><span class="line">Self is a 	<span class="built_in">table</span>: <span class="number">0x7f8353c02690</span></span><br><span class="line">Self is a 	<span class="built_in">table</span>: <span class="number">0x7f8353c068f0</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>:</code> 在函数定义阶段则表示函数会有一个参数,然后其参数名称为<strong><code>self</code></strong>.</p>
</li>
<li><p><code>:</code> 在函数调用阶段则表示将调用的Table作为第一个参数传入该函数</p>
</li>
</ul>
<p><strong><code>self</code></strong> 和 <strong><code>:</code></strong> 的意义也<strong>仅此而已</strong>,所以用时候不要想当然 尤其在底层已经封装为<code>伪类</code>结构后. 我懵圈时候<code>Google</code>到的好些人提的问题 都是因为直接使得现成架构 然后妖魔化了 这两个关键字☹️</p>
<h4 id="function-中的-…"><a href="#function-中的-…" class="headerlink" title="function 中的 …"></a>function 中的 …</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Fun1</span><span class="params">( ... )</span></span></span><br><span class="line">	<span class="keyword">local</span> a,b,c = ...</span><br><span class="line">	<span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"Arg a=%s b=%s c=%s"</span>,a,b,c))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Wrap=&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Wrap.WFun1</span><span class="params">( ... )</span></span></span><br><span class="line">	<span class="keyword">local</span> <span class="built_in">arg</span> = <span class="built_in">table</span>.pack(...)</span><br><span class="line">	<span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">pairs</span>(<span class="built_in">arg</span>) <span class="keyword">do</span></span><br><span class="line">		<span class="built_in">print</span>(k,v)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Fun1(<span class="string">"A"</span>,<span class="string">"B"</span>,<span class="string">"C"</span>,<span class="string">"D"</span>)</span><br><span class="line">Wrap.WFun1(<span class="string">"A"</span>,<span class="string">"B"</span>,<span class="string">"C"</span>,<span class="string">"D"</span>)</span><br><span class="line">Wrap:WFun1(<span class="string">"A"</span>,<span class="string">"B"</span>,<span class="string">"C"</span>,<span class="string">"D"</span>)</span><br></pre></td></tr></table></figure>
<p>输出结果为:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Arg a=A b=B c=C</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>	A</span><br><span class="line"><span class="number">2</span>	B</span><br><span class="line"><span class="number">3</span>	C</span><br><span class="line"><span class="number">4</span>	D</span><br><span class="line">n	<span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>	<span class="built_in">table</span>: <span class="number">0x7fab78406320</span></span><br><span class="line"><span class="number">2</span>	A</span><br><span class="line"><span class="number">3</span>	B</span><br><span class="line"><span class="number">4</span>	C</span><br><span class="line"><span class="number">5</span>	D</span><br><span class="line">n	<span class="number">5</span></span><br></pre></td></tr></table></figure>
<p><code>...</code>就是可变参数,必须用到函数尾部的声明 这个写匿名函数时候一般都会接触到,只不过我接触的语言有些会让你声明时候指定个名字 比如<code>...yourArgName</code>,然后直接函数内使用该名字就行了,Lua是直接用<code>...</code> 就作为名字了.</p>
<p>可以直接<code>local a,b,c = ...</code> 这样把所有参数取到, 也可以用<code>table.pack</code>组装成一个<code>table</code>(Lua5.2+),或者直接<code>{...}</code>装进一个匿名的<code>table</code>中. </p>
<p><code>教科书第四版 p62 页</code> 说的很清楚了,就不重复了</p>
<h4 id="function-中的-1"><a href="#function-中的-1" class="headerlink" title="function 中的 {}"></a>function 中的 {}</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Fun1</span><span class="params">(_arg)</span></span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(_arg) <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">print</span>(k, v)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Fun1(&#123;x = <span class="number">10</span>, y = <span class="number">15</span>, w = <span class="number">1280</span>, h = <span class="number">720</span>, title = <span class="string">"Hello"</span>&#125;)</span><br><span class="line"></span><br><span class="line">Fun1&#123;</span><br><span class="line">    title = <span class="string">"Hello2"</span>,</span><br><span class="line">    x = <span class="number">10</span>,</span><br><span class="line">    y = <span class="number">15</span>,</span><br><span class="line">    w = <span class="number">1280</span>,</span><br><span class="line">    h = <span class="number">720</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当函数只接收一个参数,且这个参数是一个table时候 <code>Fun1({})</code>可以简写成 Fun1{} </p>
<h3 id="metatable"><a href="#metatable" class="headerlink" title="metatable"></a>metatable</h3><p>metatable aka 元表 算是Lua的灵魂了吧?😓 ,这块其实只能多看 看各种人写的 从多角度去理解 我觉得是最快上手渠道.</p>
<p>重复制轮子无意义,我就说下我个人对其的理解吧</p>
<p>首先抛弃所有OOP思想,不要想那堆 就当自己刚学编程. 面向对象是什么? 完全不知道呢.</p>
<p>将所有的table都理解为一张A4白纸,恩,就是复印用的那个! 普通table是一张,metatable是另外一张</p>
<p>区分好 <code>metatable</code>,<code>setmetatable</code>:</p>
<ul>
<li><code>metatable</code> : 就是一个table表, 也就是一张普通的 A4白纸</li>
</ul>
<ul>
<li><code>setmetatable</code> : 这是一个函数</li>
</ul>
<blockquote>
<p><code>setmetatable(白纸1号,白纸1号_Mt)</code> 这个就翻译为 <code>白纸1号</code> 你大哥是 <code>白纸1号_Mt</code> 那张普通白纸. 当你有什么不懂的时候 都问他!</p>
<p>比如:</p>
<p>你说 白纸1号(PaperOne) 你和 白纸2号(PaperTwo) 加加看 我看看能弄出个啥出来! 翻译为机器码就是</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PaperOne=&#123;&#125;</span><br><span class="line">PaperOne_Mt=&#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(PaperOne,PaperOne_Mt)</span><br><span class="line"></span><br><span class="line">PaperTwo=&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> result = PaperOne+PaperTwo</span><br></pre></td></tr></table></figure>
<p>这时候 <code>白纸1号</code>就不知道这个table+table是应该怎么整了,就问<code>白纸1号_Mt</code>,大哥这个<code>table</code>+<code>table</code>怎么搞? </p>
<p>这也就是元表的 <code>算数运算</code>及<code>关系运算</code>的作用. 相关详细实现请看 教科书😑</p>
<h4 id="index-和-newindex"><a href="#index-和-newindex" class="headerlink" title="index 和 newindex"></a><strong>index 和 </strong>newindex</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">RedPaperOne = &#123;&#125;</span><br><span class="line">RedPaperTwo = &#123;&#125;</span><br><span class="line">RedPaperTwo.Name = <span class="string">"PaperTow"</span></span><br><span class="line"></span><br><span class="line">RedPaper_Mt = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(RedPaperOne, RedPaper_Mt)</span><br><span class="line"><span class="built_in">setmetatable</span>(RedPaperTwo, RedPaper_Mt)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RedPaper_Mt.__index</span><span class="params">(_table, _key)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"红纸大哥说 : 你"</span>, _table, <span class="string">"没有这个Key"</span>, _key, <span class="string">"给你个默认值 66666 好了"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"66666"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"RedPaperOne 我的名字是: "</span>, RedPaperOne.Name)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"RedPaperTwo 我的名字是: "</span>, RedPaperTwo.Name)</span><br><span class="line"></span><br><span class="line">GreenPaperOne = &#123;&#125;</span><br><span class="line">GreenPaperTwo = &#123;&#125;</span><br><span class="line">GreenPaperTwo.Name = <span class="string">"绿2号"</span></span><br><span class="line"></span><br><span class="line">GreenPaper_Mt = &#123;&#125;</span><br><span class="line">GreenPaper_Mt.Name = <span class="string">"小绿"</span></span><br><span class="line">GreenPaper_Mt.<span class="built_in">__index</span> = GreenPaper_Mt</span><br><span class="line"></span><br><span class="line"><span class="built_in">setmetatable</span>(GreenPaperOne, GreenPaper_Mt)</span><br><span class="line"><span class="built_in">setmetatable</span>(GreenPaperTwo, GreenPaper_Mt)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"GreenPaperOne 我的名字是: "</span>, GreenPaperOne.Name)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"GreenPaperTwo 我的名字是: "</span>, GreenPaperTwo.Name)</span><br><span class="line"></span><br><span class="line">BluePaperOne = &#123;&#125;</span><br><span class="line">BluePaper_Mt = &#123;&#125;</span><br><span class="line">BluePaper_Mt.<span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(_table, _key, _value)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"蓝纸大哥说: 你就是小蓝 别闹"</span>)</span><br><span class="line">    <span class="built_in">rawset</span>(_table, _key, <span class="string">"小蓝"</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">setmetatable</span>(BluePaperOne, BluePaper_Mt)</span><br><span class="line"></span><br><span class="line">BluePaperOne.Name = <span class="string">"我是小绿"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"BluePaperOne 我的名字是: "</span>, BluePaperOne.Name)</span><br></pre></td></tr></table></figure>
<p>输出结果:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">红纸大哥说 : 你	<span class="built_in">table</span>: <span class="number">0x7fa05a406930</span> 没有这个Key Name 给你个默认值 <span class="number">66666</span> 好了</span><br><span class="line"></span><br><span class="line">RedPaperOne 我的名字是: <span class="number">66666</span></span><br><span class="line">RedPaperTwo 我的名字是: PaperTow</span><br><span class="line"></span><br><span class="line">GreenPaperOne 我的名字是: 小绿</span><br><span class="line">GreenPaperTwo 我的名字是: 绿<span class="number">2</span>号</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">蓝纸大哥说: 你就是小蓝 别闹</span><br><span class="line">BluePaperOne 我的名字是: 小蓝</span><br></pre></td></tr></table></figure>
<p><code>__index</code>和 <code>__newindex</code> 都是 <code>大哥</code>身上两个特有的属性,一个负责<code>小弟</code>身上没有这个属性时候去get,另一个负责去set</p>
<p>当<code>小弟</code>身上有这个属性了,小弟是根本都不会鸟大哥的,自己就处理掉了.</p>
<p>有些时候<code>大哥</code>会把这两个<code>key</code>定义为两个函数,大哥自己真做点事儿. 但有的时候大哥就懒,直接就 <code>大哥.__index=大哥</code></p>
<p>此时小弟当处理不了时候问大哥:  大哥,那哥们儿要输出我身上的<code>Name</code>属性,我没那玩意儿啊,大哥闭着眼睑 指了指自己身上的<code>Name=小绿</code>那条记录. 小弟就心领神会的把”小绿” 返回了.</p>
<p>以上设置了一个很2B的情景,但是有些时候 碰到一些不是很容易看懂的代码 你可以是这把那段代码带入 情景,没准会更容易帮你理解.</p>
<p>有个补充就是<code>__newindex</code>内部实现使用了<code>rawset</code>,就是让小弟忽略<code>__newindex</code>实现,进行直接赋值,如果不这么写就变成自己调自己,然后无限循环下去了.</p>
<h4 id="留意-setmetatable-x-index-y"><a href="#留意-setmetatable-x-index-y" class="headerlink" title="留意 setmetatable(x,{__index=y})"></a>留意 setmetatable(x,{__index=y})</h4><p><code>setmetatable(x,{__index=y})</code> 这行代码其实有个坑,刚开始被绕进去了. 就是这里面其实是有3张表的,就是三个白纸. 还是套用上面的例子 一个是<code>白纸1号</code>,另一个是<code>白纸一号_Mt</code>. 但是里面还有一个匿名<code>table</code>就是{__index=y}</p>
<p>翻译为2B情景就是</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">PaperOne=&#123;&#125;</span><br><span class="line">PaperOne_Fake_Brother=&#123;&#125;</span><br><span class="line">PaperOne_Fake_Brother.Name=<span class="string">"我是你假大哥"</span></span><br><span class="line"></span><br><span class="line">PaperReal_Brother=&#123;&#125;</span><br><span class="line">PaperReal_Brother.Name=<span class="string">"我是你真大哥"</span></span><br><span class="line">PaperReal_Brother.<span class="built_in">__index</span>=PaperOne_Fake_Brother</span><br><span class="line"></span><br><span class="line"><span class="built_in">setmetatable</span>(PaperOne,PaperReal_Brother)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(PaperOne.Name)</span><br></pre></td></tr></table></figure>
<p>输出结果:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我是你假大哥</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.oldking.wang/fb1d9ef0-ae96-11e8-bce8-210b733613c3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/fb1d9ef0-ae96-11e8-bce8-210b733613c3/" itemprop="url">Lua从入门到入了门(1) 搭建学习环境</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-02T18:00:01+08:00">
                2018-09-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="历程"><a href="#历程" class="headerlink" title="历程"></a>历程</h3><p>最近需要给游戏加入任务系统,想着用脚本来写,方便以后扩展. 所以大概花了一周的时间折腾了一下这块.</p>
<p>目前世面主流的Unity嵌入脚本应该是两大阵营</p>
<p>C#的 <a href="http://ourpalm.github.io/ILRuntime/public/v1/guide/index.html" target="_blank" rel="noopener">ILRuntime(掌趣)</a></p>
<p>Lua的 *Lua(SLua,ToLua,XLua(腾讯))</p>
<p>最开始我是想选择ILRuntime的,不过折腾了一大圈最终还是觉得用Lua来做比较好. 目前来看我觉得这个决定还是挺明智的.</p>
<h3 id="为何写教程"><a href="#为何写教程" class="headerlink" title="为何写教程"></a>为何写教程</h3><p>我发现对于新知识会出现两种情况</p>
<p>对于某些有短期时效性的 当时会看的很明白很透彻 但是把相应问题解决完后<br>过一阵子再看 发现又忘记了很多. 比如我不止一次看过矩阵,向量.但是往往等把相关数学问题解决了,几天后回头再看 发现那坨东西已经忘的差不多了…用的时候又要重新拾起来. </p>
<p>还有一些会一直长时间使用的知识,度过了门槛期后会变成类似于一种本能. 当时那种困惑,那种百思不得其解 回头来看 会觉得很幼稚. 不知道为何那么简单的一个问题会卡那么久. </p>
<p>Lua方面的知识 我觉得会是后者. 就算现在动笔开始写教程时候 看着要写的大纲 都会有一种 这么简单 还有必要写么 的感觉. 此时已经快忘记了 最初 拿着教程 一个章节来回来去读了好几遍的样子,忘记了初看到风神写的class定义时候是有多懵圈..</p>
<p>不过 不论是哪种”知识” 我觉得写下来都是有必要的. 一个是给自己写个备忘 方便以后用时候翻查,另一个是用写作的方式 再消化一遍相关知识. 查漏补缺 加速这种本能的记忆. 并且外一有人搜到 从中获益了呢, 这也是说不准的事儿嘛😃</p>
<p>OK 絮叨到此结束,开始正题 😃</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>我是Mac,所以环境都是以Mac说的. 恩 Mac用久了 觉得Windows真是……  </p>
<p>恩 还是说Lua吧.</p>
<h2 id="安装Lua"><a href="#安装Lua" class="headerlink" title="安装Lua"></a>安装Lua</h2><p>直接<a href="https://www.lua.org/download.html" target="_blank" rel="noopener">官网下载最新的tar包</a>,解压到任意位置 命令行cd进去后执行:</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span> macosx test</span><br><span class="line"><span class="built_in">make</span> install</span><br></pre></td></tr></table></figure>
<p>一切OK后 命令行执行<code>lua</code>会看到</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Lua <span class="number">5.3</span><span class="number">.5</span>  Copyright (C) <span class="number">1994</span><span class="number">-2018</span> Lua.org, PUC-Rio</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<p>恩 这说明Lua已经安装好了.</p>
<p>虽然最终生产环境是直接是Unity内嵌 并不需要本地安装Lua,但是对于学习环境来说. 本机中直接安装Lua 会方便许多.</p>
<h2 id="设置Sublime"><a href="#设置Sublime" class="headerlink" title="设置Sublime"></a>设置Sublime</h2><p>我是比较建议 学习环境直接用 sublime编写就可以了,很方便. 不过之前也走过弯路 折腾了好多IDE ZeroBrane,Idea 等等 都有尝试过. 不过后来发现都是 瞎耽误功夫, 总想找个 写起来字号看着舒服的 能格式化代码的 又有代码提示的 还能下断点Watch的.  恩 想多了😂</p>
<h3 id="下载插件"><a href="#下载插件" class="headerlink" title="下载插件"></a>下载插件</h3><p>Sublime 其实不下载任何插件就可以直接用的,并且是内嵌Build环境的</p>
<blockquote>
<p>新建一个<code>hello.lua</code>进去写一行<code>print(&quot;Hello World&quot;)</code> 然后直接<code>cmd+b</code> 底部就会直接看结果.</p>
</blockquote>
<p>我安装的是两个插件</p>
<ul>
<li><p>LuaFormat : 国人写的 可以格式化lua代码 很方便</p>
</li>
<li><p>SublimeLinter: 需要安装三个<code>SublimeLinter</code>,<code>SublimeLinter-lua</code>,<code>SublimeLinter-luacheck</code> 用于对代码进行检查,并且报<code>Error</code>后更快速定位错误位置</p>
</li>
</ul>
<p>不过现在安插件都需要科学上网了,相关的设置可以看<a href="http://oldking.wang/248f6fe0-adeb-11e8-b21f-6b22e33454a2/" target="_blank" rel="noopener">我之前写的文章</a></p>
<h3 id="调整Sidebar文本大小"><a href="#调整Sidebar文本大小" class="headerlink" title="调整Sidebar文本大小"></a>调整Sidebar文本大小</h3><p>这个其实是我个人问题,因为换了一个4K的带鱼屏Sublime的Sidebar中的文字看着巨小.所以需要设置一下. 具体设置方法是:</p>
<p><code>Sublime-&gt;Perferences-&gt;Browse Packages...</code></p>
<p>然后在<code>User</code>目录下建立文件<code>Default.sublime-theme</code>,内容如下:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"class"</span>: <span class="string">"sidebar_label"</span>,</span><br><span class="line">        <span class="attr">"font.size"</span>: <span class="number">22</span></span><br><span class="line">    &#125;,</span><br><span class="line">     &#123;</span><br><span class="line">        <span class="attr">"class"</span>: <span class="string">"sidebar_tree"</span>,</span><br><span class="line">        <span class="attr">"row_padding"</span>: [<span class="number">8</span>, <span class="number">8</span>],</span><br><span class="line">        <span class="attr">"indent"</span>: <span class="number">12</span>,</span><br><span class="line">        <span class="attr">"indent_offset"</span>: <span class="number">17</span>,</span><br><span class="line">        <span class="attr">"indent_top_level"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"layer0.tint"</span>: [<span class="number">230</span>, <span class="number">230</span>, <span class="number">230</span>],</span><br><span class="line">        <span class="attr">"layer0.opacity"</span>: <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">"dark_content"</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><img src="/media/15359020871991.jpg" alt=""></p>
<h2 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h2><p>在任意位置新建一个文件夹,比如叫<code>Lua</code>,然后在其下新建一个<code>mian.lua</code>,加入一行<code>print(&quot;Hello World&quot;)</code>. </p>
<p>将<code>Lua</code>文件夹整体拖入到<code>Sublime</code>中来,此时左侧<code>Side Bar</code>会显示,单击<code>main.lua</code>,然后<code>cmd+b</code>直接编译运行即可.</p>
<p><img src="/media/15359024627409.jpg" alt=""></p>
<h2 id="学习资料"><a href="#学习资料" class="headerlink" title="学习资料"></a>学习资料</h2><h3 id="入门1小时"><a href="#入门1小时" class="headerlink" title="入门1小时"></a>入门1小时</h3><p>和我一样的Lua纯白我建议先看<a href="https://youtu.be/iMacxZQMPXs" target="_blank" rel="noopener">Y2B上面的这个视频</a>, 一个小时从0开始 整体给过了一遍如何写Lua. 作为初步了解 会比看书要快很多.</p>
<h3 id="教科书"><a href="#教科书" class="headerlink" title="教科书"></a>教科书</h3><p>我最近就买过两本书 一本是Unity Shader的 另外一本就是 这个 <a href="https://item.jd.com/12384305.html" target="_blank" rel="noopener">Lua程序设计 第四版</a>, 其实我最开始是看网上PDF版的 不过目前能找到的 只有 <code>第二版</code>和第四版的英文版.</p>
<p>建议还是看第四版,因为第四和第二之间间隔了很久,好多东西都改了. 比如<code>module()</code>这个因为过度设计 新版已经都废弃掉了 直接用<code>_ENV</code>即可.</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>看完视频撸完书 下一步要解决的就是 怎么开始正式写代码.</p>
<p>理想中的Coding环境就是 写个入口文件 <code>main.lua</code> 然后每个类一个文件 从入口文件的某个函数开始执行 然后把整个程序Run起来.</p>
<p>这也就是我后续教程会Cover的部分.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.oldking.wang/248f6fe0-adeb-11e8-b21f-6b22e33454a2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/248f6fe0-adeb-11e8-b21f-6b22e33454a2/" itemprop="url">Sublime使用代理更新PackageControl</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-01T21:30:07+08:00">
                2018-09-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/其他/" itemprop="url" rel="index">
                    <span itemprop="name">其他</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="被墙"><a href="#被墙" class="headerlink" title="被墙"></a>被墙</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Package Control</span><br><span class="line"></span><br><span class="line">There are <span class="keyword">no</span> packages available <span class="keyword">for</span> installation</span><br><span class="line"></span><br><span class="line">Please see http<span class="variable">s:</span>//packagecontrol.io/docs/troubleshooting <span class="keyword">for</span> <span class="keyword">help</span></span><br></pre></td></tr></table></figure>
<p>恩 这年头 不会点<code>科学上网</code>连个Sublime插件都更新不下来 唉</p>
<h2 id="挖洞"><a href="#挖洞" class="headerlink" title="挖洞"></a>挖洞</h2><p>首先挖掘机试SS,不支持Http代理. 所以要先安装<code>polipo</code>将socket5的转成http</p>
<h3 id="安装Polipo"><a href="#安装Polipo" class="headerlink" title="安装Polipo"></a>安装Polipo</h3><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">brew </span><span class="keyword">install </span>polipo</span><br></pre></td></tr></table></figure>
<h3 id="设置socket5转http"><a href="#设置socket5转http" class="headerlink" title="设置socket5转http"></a>设置socket5转http</h3><p>查看自己SS的监听端口</p>
<p><img src="/media/15358096727331.jpg" alt=""></p>
<p>然后命令行执行</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">polipo <span class="attribute">socksParentProxy</span>=localhost:1086</span><br></pre></td></tr></table></figure>
<p>我的端口是<code>1086</code>,这块要换成你自己的</p>
<p>运行成功后出现</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Established listening socket on<span class="built_in"> port </span>8123.</span><br></pre></td></tr></table></figure>
<h3 id="设置Sublime的PackageControl使用代理"><a href="#设置Sublime的PackageControl使用代理" class="headerlink" title="设置Sublime的PackageControl使用代理"></a>设置Sublime的PackageControl使用代理</h3><p><img src="/media/15358098449757.jpg" alt=""></p>
<p>按图进入<code>Sublime</code> PackageControl的 <code>Settings-Users</code></p>
<p>添加</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"http_proxy"</span>: <span class="string">"http://127.0.0.1:8123"</span>,</span><br><span class="line"><span class="string">"https_proxy"</span>: <span class="string">"http://127.0.0.1:8123"</span>,</span><br></pre></td></tr></table></figure>
<p>如图<br><img src="/media/15358099198000.jpg" alt=""></p>
<p>恩 然后一切就大功告成了.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.oldking.wang/b85b98c0-9801-11e8-8ddf-cf091e5f791e/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/b85b98c0-9801-11e8-8ddf-cf091e5f791e/" itemprop="url">如何正确的使用Unity的Sprite Atlas</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-05T00:16:19+08:00">
                2018-08-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index">
                    <span itemprop="name">Unity</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>做了几个关于spriteatlas的实验,收获不少. 过程懒得写了.就把最后关键的两点列一下吧.</p>
<h2 id="显存"><a href="#显存" class="headerlink" title="显存"></a>显存</h2><p>当img被放入纹理集以后,无论原img是否在<code>Resources</code>目录.显存中均使用的是纹理集而非原始图片.</p>
<p>比如游戏中有10个物品,背包展示时候 你通过<code>Resource.Load&lt;Sprite&gt;($imgPath)</code>加载对应的图片进行展示. 但是该图片已经被打入纹理集了. 则此时显存中加载的是纹理集而非单张图片素材</p>
<p><img src="/media/Jietu20180804-235830.jpg" alt="Jietu20180804-235830"></p>
<p>如图,裸包19个纹理 打成纹理集后 无论如何折腾都是20个纹理.</p>
<h2 id="APK包体"><a href="#APK包体" class="headerlink" title="APK包体"></a>APK包体</h2><p>原始图片如果放入<code>Resources</code>目录则会被全量打入APK(即使根本用不到☹️). 但是如果放在外部,只有纹理集放入<code>Resources</code>目录则原素材只会打入很小一部分信息.</p>
<p><img src="/media/Jietu20180805-001221.jpg" alt="Jietu20180805-001221"></p>
<p><img src="/media/Jietu20180805-001021.jpg" alt="Jietu20180805-001021"></p>
<p>恩 这个是比较尴尬的地方了. </p>
<p>如果所有图片都是被间接引用的. 比如一个Prefab里面有一个节点挂了一个SpreiteRender然后引用了Pic1.jpg.</p>
<p>这时候只要把Img和纹理集都丢到<code>Resource</code>目录外面即可. 打出包来 结构也会和方案2一样的.</p>
<p>但是 如果项目中存在 需要用路径去进行<code>Resource.Lord&lt;Sprite&gt;($imgPath)</code>来访问资源时候. 原始资源如果不在<code>Resource</code>目录就根本访问不到.</p>
<p>此时需要首先Load到纹理集,然后通过<code>GetSprites</code>方法访问到相应纹理. 也就是自己需要维护一份纹理集和图片的从属关系.然后封装一下Load函数才行.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.oldking.wang/02be5110-96ee-11e8-b96a-33aa607b4d67/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/02be5110-96ee-11e8-b96a-33aa607b4d67/" itemprop="url">出现 XXX can only be called on an active agent that has been placed on a NavMesh 的原因及解决方法</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-03T15:22:42+08:00">
                2018-08-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index">
                    <span itemprop="name">Unity</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h2><blockquote>
<p>“IsStopped” can only be called on an active agent that has been placed on a NavMesh.</p>
</blockquote>
<hr>
<blockquote>
<p>“GetRemainingDistance” can only be called on an active agent that has been placed on a NavMesh.</p>
</blockquote>
<p>或者其他类似的,由于没有把NavMeshAgent放置在NavMesh所导致的错误</p>
<h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>大部分原因是两种</p>
<ul>
<li>初始化时候放置的NavMeshAgent的Position比NavMesh要低.</li>
</ul>
<p>比如像我自己的项目,就出现这种情况. 我的NavMesh最后<code>Bake</code>完所在的平面是(0,0.2f,0) 也就是 <code>y = 0.2f</code> 的平面. 但是我创建NavMeshAgent时候,其在Prefab中默认的坐标是(0,0,0)</p>
<ul>
<li>Agent之前在NavMesh上面.但是后面通过设置<code>transfrom.position</code>导致其偏离的NavMesh.</li>
</ul>
<p>以上两种情况都会出现 如下的错误信息</p>
<blockquote>
<p>XXX can only be called on an active agent that has been placed on a NavMesh</p>
</blockquote>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><ul>
<li>初始化时候就设置Position偏移</li>
</ul>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Prefab ;</span><br><span class="line"><span class="keyword">var</span> offsetV3 = <span class="keyword">new</span> <span class="type">Vector</span>(<span class="number">0</span>,<span class="number">0.21</span>f,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="keyword">new</span><span class="type">Go</span> = GameObject.Instantiate(Prefab, offsetV3, Quaternion.identity);</span><br></pre></td></tr></table></figure>
<ul>
<li>使用Wrap函数</li>
</ul>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Prefab;</span><br><span class="line"><span class="keyword">var</span> offsetV3 = <span class="keyword">new</span> <span class="type">Vector</span>(<span class="number">0</span>,<span class="number">0.21</span>f,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="keyword">new</span><span class="type">Go</span> = GameObject.Instantiate(Prefab);</span><br><span class="line"><span class="keyword">var</span> agent = <span class="keyword">new</span><span class="type">Go</span>.GetComponent&lt;NavMeshAgent&gt;();</span><br><span class="line">agent.Wrap(offsetV3);</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.oldking.wang/3dbcea40-93fd-11e8-82b5-5f6e29863172/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/3dbcea40-93fd-11e8-82b5-5f6e29863172/" itemprop="url">Unity UGUI Image 善用纹理的WrapMode</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-30T21:34:10+08:00">
                2018-07-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index">
                    <span itemprop="name">Unity</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p><img src="/media/Jietu20180730-213540.jpg" alt="Jietu20180730-213540"></p>
<p>做之前箭头演示Demo时候,直接Tiled抻拉了箭头Body部分. 底下有一段Warning提示,之前一直没注意.今天无意间看到了.</p>
<blockquote>
<p>It looks like you want to tile a sprite with no border. It would be more efficient to …</p>
</blockquote>
<h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>其实这个说的是使用纹理的WrapMode设置错了. 虽然可以做到Tiled.但是效率不高.</p>
<p>切换到<code>Wireframe</code>下看的一目了然.</p>
<p><img src="/media/Jietu20180730-214355.jpg" alt="Jietu20180730-214355"></p>
<p>可以看到 <code>Clamp</code>是通过绘制了多个”方块”才达到的Tiled,而<code>Repeat</code>只绘制了一个”方块”. 专业一点的说法就是后者 使用的顶点(vertices)比前者少. 所以性能会高 😀</p>
<h2 id="引申阅读"><a href="#引申阅读" class="headerlink" title="引申阅读"></a>引申阅读</h2><p><a href="https://blog.csdn.net/lzhq1982/article/details/75045358" target="_blank" rel="noopener">Unity Shader入门精要笔记（十二）：纹理属性</a><br>里面有详细的介绍 <code>Clamp</code>和<code>Repeat</code>的区别</p>
<p><code>Repeat</code><br><img src="/media/20170712210355009.jpg" alt="20170712210355009"></p>
<p><code>Clamp</code><br><img src="/media/20170712210408517.jpg" alt="20170712210408517"></p>
<p>注意 Clamp 是对纹理外围1像素进行无限抻拉. 详情也可参照 <a href="https://docs.unity3d.com/ScriptReference/TextureWrapMode.Clamp.html" target="_blank" rel="noopener">官网API TextureWrapMode.Clamp</a></p>
<blockquote>
<p>Clamps the texture to the last pixel at the edge.</p>
<p>This is useful for preventing wrapping artifacts when mapping an image onto an object and you don’t want the texture to tile. UV coordinates will be clamped to the range 0…1. When UVs are larger than 1 or smaller than 0, the last pixel at the border will be used.</p>
<p>This mode is called “clamp to edge” in graphics APIs like Vulkan, Metal and OpenGL.</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">隔壁老王</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">37</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">29</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">隔壁老王</span>

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  






  
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine@1.1.4/dist/Valine.min.js"></script>
  <script type="text/javascript">
    new Valine({
        av: AV,
        el: '#vcomments' ,
        verify: false,
        notify: false,
        app_id: 'VgjGdP2hIi00FTVlhhkQYpOx-gzGzoHsz',
        app_key: 'f6jqD57DmTmu5lR3DdobF3py',
        placeholder: '说点啥?'
    });
  </script>



  





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

  

</body>
</html>
