<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="HaFr6IFRWpWkG_Eyt4dUUQlgTyTE85bMpbJKQQgp0Rw" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="独立游戏开发者">
<meta property="og:type" content="website">
<meta property="og:title" content="隔壁老王">
<meta property="og:url" content="http://oldking.wang/index.html">
<meta property="og:site_name" content="隔壁老王">
<meta property="og:description" content="独立游戏开发者">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="隔壁老王">
<meta name="twitter:description" content="独立游戏开发者">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://oldking.wang/"/>





  <title>隔壁老王</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-111727312-1', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">隔壁老王</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">独立游戏开发者</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-unity">
          <a href="/categories/Unity" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-diamond"></i> <br />
            
            Unity
          </a>
        </li>
      
        
        <li class="menu-item menu-item-c#">
          <a href="/categories/C#" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-graduation-cap"></i> <br />
            
            C#
          </a>
        </li>
      
        
        <li class="menu-item menu-item-其他">
          <a href="/categories/其他" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-beer"></i> <br />
            
            其他
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oldking.wang/00e482d0-3558-11e8-bda2-bf71a18d2be3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/00e482d0-3558-11e8-bda2-bf71a18d2be3/" itemprop="url">Unity新版AssetBundles使用手札</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-01T10:54:32+08:00">
                2018-04-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index">
                    <span itemprop="name">Unity</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="使用目的"><a href="#使用目的" class="headerlink" title="使用目的"></a>使用目的</h3><p>之前的项目(单机弱联网),所有资源一直放置在<code>Resources</code>目录,后来因为期望将配置文件放到服务器.可以实现<code>不发版本从而更新配置文件的</code>目的 开始接触<code>AssetBundles</code></p>
<h3 id="生成AssetBundles"><a href="#生成AssetBundles" class="headerlink" title="生成AssetBundles"></a>生成AssetBundles</h3><p>新版的<code>AssetBundles</code>(Unity 5.0+,2017,2018…) 相比旧版省事很多.看了下<a href="https://docs.unity3d.com/ScriptReference/BuildPipeline.html" target="_blank" rel="noopener">API</a>原有的函数</p>
<p><code>BuildPipeline.BuildAssetBundle</code>已经被<strong>弃用</strong>了.目前AB应该只使用</p>
<p><code>BuildPipeline.BuildAssetBundles</code> 进行全部的AB文件打包.</p>
<h4 id="打包代码"><a href="#打包代码" class="headerlink" title="打包代码"></a>打包代码</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">MenuItem(<span class="meta-string">"CopyEngine/AssetBundles/Build All"</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">BuildAllAssetBundles</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Directory.Exists(FOLDER_PATH))</span><br><span class="line">    &#123;</span><br><span class="line">        CEOneKeyReleaseUtils.DeleteFolder(FOLDER_PATH);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Directory.CreateDirectory(FOLDER_PATH);</span><br><span class="line"></span><br><span class="line">    DoBuildBundles(<span class="string">"Mac"</span>, BuildTarget.StandaloneOSX);</span><br><span class="line">    DoBuildBundles(<span class="string">"Android"</span>, BuildTarget.Android);</span><br><span class="line">    DoBuildBundles(<span class="string">"IOS"</span>, BuildTarget.iOS);</span><br><span class="line">    DoBuildBundles(<span class="string">"Win"</span>, BuildTarget.StandaloneWindows);</span><br><span class="line">    Caching.ClearCache();</span><br><span class="line">    AssetDatabase.Refresh();</span><br><span class="line">    Debug.Log(<span class="string">"Done build all assets bundles"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DoBuildBundles</span>(<span class="params"><span class="keyword">string</span> _subFolder, BuildTarget _target</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> assetBundleDirectory = FOLDER_PATH + <span class="string">"/"</span> + _subFolder;</span><br><span class="line">    <span class="keyword">if</span> (!Directory.Exists(assetBundleDirectory))</span><br><span class="line">    &#123;</span><br><span class="line">        Directory.CreateDirectory(assetBundleDirectory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BuildPipeline.BuildAssetBundles(assetBundleDirectory, BuildAssetBundleOptions.None, _target);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="缓存机制"><a href="#缓存机制" class="headerlink" title="缓存机制"></a>缓存机制</h3><p>缓存基础知识可以参考<a href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-usage-patterns" target="_blank" rel="noopener">AssetBundle usage patterns</a>的<code>4.2.1. Shipped with project</code>~<code>4.2.3. Built-in caching</code>这块.</p>
<p>核心部分就是使用<code>UnityWebRequest</code>下载并读取<code>AB</code></p>
<h4 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h4><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//<span class="doctag">TODO:</span></span></span><br></pre></td></tr></table></figure>
<h3 id="AssetBundleManifest"><a href="#AssetBundleManifest" class="headerlink" title="AssetBundleManifest"></a>AssetBundleManifest</h3><p>首先要注意的是,使用<code>BuildPipeline.BuildAssetBundles</code>打包生成<code>AB</code>目录,会有两个<code>AssetBundleManifest</code>文件. 比如上面的打包代码</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">DoBuildBundles</span>(<span class="string">"Android"</span>, BuildTarget.Android);</span><br></pre></td></tr></table></figure>
<p>会在指定的目录下生成一个名叫<code>Android</code>的目录,其内部放置的<code>AB</code>素材是适合安卓平台下使用的. 同时会产生一个 名字叫<code>Android</code>但是没有后缀,另外一个有<code>manifest</code>后缀的文件(Android.manifest)</p>
<p><code>Android.manifest</code>这个文件<strong>不是</strong>真正的<code>AssetBundleManifest</code>,没有文件名的那个文件才是.</p>
<p><code>*.manifest</code>在旧版的API文档(低于Unity5.0)中有说明,是用于内部构建使用,也就是可以直接忽略不管的.</p>
<p>真正需要加载的文件是没有文件名的那个.</p>
<h3 id="将AB文件放入StreamingAssets"><a href="#将AB文件放入StreamingAssets" class="headerlink" title="将AB文件放入StreamingAssets"></a>将AB文件放入StreamingAssets</h3><p>将AB放入或者不放入<code>StreamingAssets</code>要看项目而定. 主要是在包体大小和进入等待时间之间做一个平衡吧.</p>
<h4 id="核心代码-1"><a href="#核心代码-1" class="headerlink" title="核心代码"></a>核心代码</h4><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//<span class="doctag">TODO:</span></span></span><br></pre></td></tr></table></figure>
<h4 id="补充说明"><a href="#补充说明" class="headerlink" title="补充说明"></a>补充说明</h4><p>在安卓平台<code>StreamingAssets</code>中的文件是放入一个<code>jar</code>包之中保存的,所以正常的方法是<strong>无法</strong>查找某一个文件是否存在的.</p>
<p>比如在Editor或者Standalone中是可以直接用<code>File.Exist(xxx)</code>判断是否存在某一个<code>AB</code>,从而决定是从<code>StreamingAssets</code>中加载还是从<code>UnityWebRequest</code>中请求.</p>
<p>但是在安卓中是不可以.</p>
<p>目前我想到的是两种方式, 一种是在生成AB包时候同时生成相应的配置文件,通过该文件来实现<code>File.Exist(xxx)</code>的逻辑.</p>
<p>另外一种是使用try-catch然后直接生取对应的AB文件. 进行异常监听. </p>
<p>目前我项目中使用的是第二种方式.</p>
<h3 id="我AB的使用方式"><a href="#我AB的使用方式" class="headerlink" title="我AB的使用方式"></a>我AB的使用方式</h3><p>目前我项目中的<code>AB</code>使用流程如下</p>
<p><strong>1–&gt;</strong> 使用文章开头提供的脚本在单独的项目中打包所有<code>AB</code></p>
<blockquote>
<p>使用单独项目原因是,如果主项目很大,每次打包要好久. 将需要打包的资源单独放置一个新项目中会快很多</p>
</blockquote>
<p><strong>2–&gt;</strong> 将生成好的全平台(“Mac”,”Windows”,”Android”,”IOS”)AB,Copy到主项目的<code>StreamingAssets</code>目录下</p>
<p>同时Copy一份到主目录外(用于一键打包脚本)</p>
<blockquote>
<p>这样做的好处是在开发阶段测试很方便,打包每个平台的测试工程均可,且无需联网下载<code>AB</code></p>
<p>(代码中需要设置,在测试环境中只使用<code>StreamingAssets</code>中的AB)</p>
</blockquote>
<p><strong>3–&gt;</strong> 使用一键发布脚本进行安卓或者IOS平台打包:</p>
<p>首先删除<code>StreamingAssets</code>目录下的全平台AB<br>再根据平台不同,将主目录外的备份文件.相应的Copy进来</p>
<p><strong>4–&gt;</strong> 正式工程取得某个AB时候</p>
<p>首先请求<code>AssetBundleManifest</code>文件(从服务器请求,不缓存)</p>
<p>然后从中取得该<code>AB</code>的Hash值. 用该值和<code>StreamingAssets</code>中的<code>AB</code>进行比较. 如果相同则直接从<code>StreamingAssets</code>中加载.(注意,<strong>不能</strong>使用<code>UnityWebRequest</code>进行加载,否则会复制出一份缓存文件来).</p>
<p>如果不相同,则使用该<code>Hash</code>做key 通过<code>UnityWebRequest</code>请求. 这样会把相应的<code>AB</code>缓存下来. 下次不需要再从服务器中下载.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oldking.wang/4242f7f0-1714-11e8-9242-bf2f9719042a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/4242f7f0-1714-11e8-9242-bf2f9719042a/" itemprop="url">创建 Isometric Tile Mesh用于Unity原生Navigation寻路</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-21T22:34:01+08:00">
                2018-02-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index">
                    <span itemprop="name">Unity</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>Unity 无论自身的TileMap(2018版本),还是Asset Store中的插件,对于Isometric(斜45度)的地图支持的都不好.几乎都处于不可用的状态中.</p>
<p>唯一一个不错的且免费的插件是<a href="!http://www.seanba.com/tiled2unity">Tiled2Unity</a></p>
<p>插件的原理是使用<a href="!http://www.mapeditor.org/">Tiled</a>对地图进行编辑,然后通过该插件导入到Unity中使用. </p>
<p>其地图导入部分做的很好,Isometric的地图完全没有问题. 但是其引入的是<code>PolygonCollider2D</code>作为物理碰撞.</p>
<p>对于纯2D的横版游戏完全没有问题.但是如果是俯视的大地图 比如 金庸群侠传,英雄无敌 等等 这种视角的游戏, 如果需要使用原生的寻路系统(NavMeshAgent). 就必须要自己想办法</p>
<p>其实工具内部可以自己写<code>ICustomTiledImporter</code>实现,然后在Tiled中使用AutoTile,编辑相应的规则.</p>
<p>最终实现的流程是就是</p>
<ul>
<li>编辑AutoTile,使得放置地表时候自动创建Tile Object(粉色的那个,在ObjectLayer).</li>
<li>自己写<code>ICustomTiledImporter</code>读取相应的Property.然后生成相应的Unity中的GameObject</li>
</ul>
<h2 id="我的方案"><a href="#我的方案" class="headerlink" title="我的方案"></a>我的方案</h2><p>使用AutoTile我觉得太麻烦,所以直接写个工具,将Map导出一份Json,读入Json中的Property信息即可以.<br>所以就剩下第二部分逻辑. 在相应的Tile部分生成GameObject用于NavMesh 的 Bake.</p>
<p>就是在Tiled中创建两个色块Tile(红色,绿色). 红色的色块是不能走的地方,绿色色块是可以走的地方</p>
<p>在Unity中读取对应的信息,找到红色和绿色色块.在对应的位置放置上红色的Prefab和绿色的Prefab.</p>
<p>这种两个Prefab就是一个空的3D物品,然后设置成<code>Navigation Static</code>,一个设置为<code>Walkable</code>,一个设置为<code>NotWalkable</code></p>
<p>然后直接Bake NavMesh即可.</p>
<p>所以最终的问题 就是如何产生这个 红色或者绿色的Prefab.</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>生成相应的Mesh代码如下.</p>
<p>我使用了<code>OdinInspector</code>制作界面.如果不是用则自定义CustomEditor放置两个按钮对应<code>MakeTile</code>和<code>SaveTile</code>即可</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line">[<span class="meta">RequireComponent(typeof(MeshFilter))</span>]</span><br><span class="line">[<span class="meta">RequireComponent(typeof(MeshRenderer))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MeshTileMaker</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> A = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> B = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> C = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> D = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> AP = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> BP = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> CP = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> DP = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> TILE_HEIGH;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">LabelText(<span class="meta-string">"Tile的宽度:"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> TILE_WIDTH = <span class="number">0.64</span>f;</span><br><span class="line">    [<span class="meta">LabelText(<span class="meta-string">"3D模型的高度:"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> CUBE_HEIGH = <span class="number">0.2</span>f;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    [<span class="meta">Button(ButtonSizes.Large)</span>]</span><br><span class="line">    [<span class="meta">ButtonGroup(<span class="meta-string">"Function"</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MakeTile</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        DoMakeTile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">GUIColor(0, 1, 0)</span>]</span><br><span class="line">    [<span class="meta">ButtonGroup(<span class="meta-string">"Function"</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SaveTile</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">string</span> path = EditorUtility.SaveFilePanel(<span class="string">"Save Mesh"</span>, <span class="string">"Assets/"</span>, name, <span class="string">"asset"</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(path)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        path = FileUtil.GetProjectRelativePath(path);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> filter = GetComponent&lt;MeshFilter&gt;();</span><br><span class="line">        <span class="keyword">var</span> meshToSave = filter.mesh;</span><br><span class="line"></span><br><span class="line">        MeshUtility.Optimize(meshToSave);</span><br><span class="line"></span><br><span class="line">        AssetDatabase.CreateAsset(meshToSave, path);</span><br><span class="line">        AssetDatabase.SaveAssets();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DoMakeTile</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        TILE_HEIGH = TILE_WIDTH / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">var</span> HALF_WIDHT = TILE_WIDTH / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">var</span> HALF_HEIGH = TILE_HEIGH / <span class="number">2</span>;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> vertices = <span class="keyword">new</span> Vector3[<span class="number">8</span>];</span><br><span class="line">        vertices[A] = <span class="keyword">new</span> Vector3(-HALF_WIDHT, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        vertices[B] = <span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">0</span>, HALF_HEIGH);</span><br><span class="line">        vertices[C] = <span class="keyword">new</span> Vector3(HALF_WIDHT, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        vertices[D] = <span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">0</span>, -HALF_HEIGH);</span><br><span class="line"></span><br><span class="line">        vertices[AP] = <span class="keyword">new</span> Vector3(-HALF_WIDHT, CUBE_HEIGH, <span class="number">0</span>);</span><br><span class="line">        vertices[BP] = <span class="keyword">new</span> Vector3(<span class="number">0</span>, CUBE_HEIGH, HALF_HEIGH);</span><br><span class="line">        vertices[CP] = <span class="keyword">new</span> Vector3(HALF_WIDHT, CUBE_HEIGH, <span class="number">0</span>);</span><br><span class="line">        vertices[DP] = <span class="keyword">new</span> Vector3(<span class="number">0</span>, CUBE_HEIGH, -HALF_HEIGH);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> triangles = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">12</span> * <span class="number">3</span>];</span><br><span class="line">        <span class="keyword">var</span> startIndex = <span class="number">0</span>;</span><br><span class="line">        DoPushTriangles(<span class="keyword">ref</span> triangles, <span class="keyword">ref</span> startIndex, D, B, A);</span><br><span class="line">        DoPushTriangles(<span class="keyword">ref</span> triangles, <span class="keyword">ref</span> startIndex, C, B, D);</span><br><span class="line"></span><br><span class="line">        DoPushTriangles(<span class="keyword">ref</span> triangles, <span class="keyword">ref</span> startIndex, AP, BP, DP);</span><br><span class="line">        DoPushTriangles(<span class="keyword">ref</span> triangles, <span class="keyword">ref</span> startIndex, BP, CP, DP);</span><br><span class="line"></span><br><span class="line">        DoPushTriangles(<span class="keyword">ref</span> triangles, <span class="keyword">ref</span> startIndex, AP, DP, A);</span><br><span class="line">        DoPushTriangles(<span class="keyword">ref</span> triangles, <span class="keyword">ref</span> startIndex, A, DP, D);</span><br><span class="line"></span><br><span class="line">        DoPushTriangles(<span class="keyword">ref</span> triangles, <span class="keyword">ref</span> startIndex, D, DP, CP);</span><br><span class="line">        DoPushTriangles(<span class="keyword">ref</span> triangles, <span class="keyword">ref</span> startIndex, D, CP, C);</span><br><span class="line"></span><br><span class="line">        DoPushTriangles(<span class="keyword">ref</span> triangles, <span class="keyword">ref</span> startIndex, B, BP, AP);</span><br><span class="line">        DoPushTriangles(<span class="keyword">ref</span> triangles, <span class="keyword">ref</span> startIndex, B, AP, A);</span><br><span class="line"></span><br><span class="line">        DoPushTriangles(<span class="keyword">ref</span> triangles, <span class="keyword">ref</span> startIndex, C, CP, BP);</span><br><span class="line">        DoPushTriangles(<span class="keyword">ref</span> triangles, <span class="keyword">ref</span> startIndex, C, BP, B);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> mesh = <span class="keyword">new</span> Mesh &#123;name = <span class="string">"TileMesh"</span>&#125;;</span><br><span class="line">        mesh.vertices = vertices;</span><br><span class="line">        mesh.triangles = triangles;</span><br><span class="line">        GetComponent&lt;MeshFilter&gt;().mesh = mesh;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DoPushTriangles</span>(<span class="params"><span class="keyword">ref</span> <span class="keyword">int</span>[] _triangles, <span class="keyword">ref</span> <span class="keyword">int</span> _startIndex, <span class="keyword">int</span> _A, <span class="keyword">int</span> _B, <span class="keyword">int</span> _C</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _triangles[_startIndex] = _A;</span><br><span class="line">        _triangles[_startIndex + <span class="number">1</span>] = _B;</span><br><span class="line">        _triangles[_startIndex + <span class="number">2</span>] = _C;</span><br><span class="line">        _startIndex += <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20180221-230512.jpg" alt="QQ20180221-230512"></p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20180221-230021.jpg" alt="QQ20180221-230021"></p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20180221-230057.jpg" alt="QQ20180221-230057"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oldking.wang/98516910-f9d2-11e7-9821-d3ed16e6835d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/98516910-f9d2-11e7-9821-d3ed16e6835d/" itemprop="url">Unity在编辑模式中使用代码更新Prefab并保持引用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-15T17:00:55+08:00">
                2018-01-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index">
                    <span itemprop="name">Unity</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h2><p>一键将EditMap导出为ReleaseMap. 在编辑场景构建游戏地图,地图数据中绑定了许多只有编辑场景才会用到的数据.比如用于生成NavMesh的Cube,用于场景排序的代码等等.</p>
<p>希望构建点击一个按钮,对应的导出一份Release版本的地图Prefab数据. 用于游戏场景中使用. 同时再次运行脚本时候,游戏场景中对于该Prefab的引用不会消失</p>
<p>相当于点击了 Inspector中Prefab的 Apply按钮</p>
<h2 id="核心代码示例"><a href="#核心代码示例" class="headerlink" title="核心代码示例"></a>核心代码示例</h2><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> void OnClickBtn()</span><br><span class="line"> &#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">var</span> <span class="keyword">new</span><span class="type">Go</span> = <span class="keyword">new</span> <span class="type">GameObject</span>();</span><br><span class="line">     <span class="keyword">new</span><span class="type">Go</span>.name = <span class="string">"OutPrefab"</span>;</span><br><span class="line">     <span class="keyword">var</span> sp = <span class="keyword">new</span><span class="type">Go</span>.AddComponent&lt;PrefabOutCode&gt;();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">var</span> cubeAPath = <span class="string">"Assets/TestGround/NeedLinkPrefab/CubeA.prefab"</span>;</span><br><span class="line">     <span class="keyword">var</span> cubeA = (GameObject) AssetDatabase.LoadAssetAtPath(cubeAPath, typeof(GameObject));</span><br><span class="line"></span><br><span class="line">     sp.linkPrefab = cubeA;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="keyword">var</span> outPrefabPath = <span class="string">"Assets/TestGround/OutPrefab/OutPrefab.prefab"</span>;</span><br><span class="line">     <span class="keyword">var</span> outPreafb = (GameObject) AssetDatabase.LoadAssetAtPath(outPrefabPath, typeof(GameObject));</span><br><span class="line"></span><br><span class="line">     PrefabUtility.ReplacePrefab(<span class="keyword">new</span><span class="type">Go</span>, outPreafb, ReplacePrefabOptions.ReplaceNameBased);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     DestroyImmediate(<span class="keyword">new</span><span class="type">Go</span>);</span><br><span class="line"></span><br><span class="line">     Debug.Log(<span class="string">"DONE"</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>目录结构:</p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20180115-171117.jpg" alt="QQ20180115-171117"></p>
<p><code>AssetDatabase.LoadAssetAtPath</code> 可以加载到目录中的Prefab</p>
<p><code>sp.linkPrefab = cubeA</code> 将Preafb Link到GameObject中来. 比如新生成的GameObject有个public 变量<br>需要Link 一个AudioClip. (就是替代原来的 用鼠标将Prefab拖拽到Inspector中的操作)</p>
<p><code>PrefabUtility.ReplacePrefab(newGo, outPreafb, ReplacePrefabOptions.ReplaceNameBased)</code></p>
<p>使用<code>ReplacePrefabOptions.ReplaceNameBased</code>这种方式,可以在保证原有Preafb引用不丢失的情况下替换.</p>
<p>默认的<code>Default</code>模式会全部替换,但是引用丢失.</p>
<p>使用<code>ConnectToPrefab</code>会在原有的基础上增加东西,引用不会丢失</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oldking.wang/d8549fe0-f91a-11e7-8661-1f20a751e9e4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/d8549fe0-f91a-11e7-8661-1f20a751e9e4/" itemprop="url">Unity动态加载NavMesh</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-14T19:05:35+08:00">
                2018-01-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index">
                    <span itemprop="name">Unity</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20180114-190238-HD.gif" alt="QQ20180114-190238-HD"></p>
<p>新版本的Unity可以将NavMeshData存成一个Prefab,在任意场景(即使不是同一个项目).动态的加载进来.或者在编辑模式加载均可.</p>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><p>手先从Github上面Check下来适合自己IDE的插件: <a href="https://github.com/Unity-Technologies/NavMeshComponents" target="_blank" rel="noopener">地址</a></p>
<p>使用其内置的<code>NavMeshSurface</code>配合其他的Component生成对应的NavMeshData.</p>
<p>注意:不要使用<code>Navigation</code>标签下的Bake按钮生成NavMesh. 该标签下生成的NavMesh是旧版本,只能用于生成的场景.</p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20180114-191550.jpg" alt="QQ20180114-191550"></p>
<p>生成的NavMesh会在场景所在的层级下面同名文件夹内</p>
<p>名字为<code>NavMesh-</code> + GameObject的名字</p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20180114-191649.jpg" alt="QQ20180114-191649"></p>
<h2 id="加载代码"><a href="#加载代码" class="headerlink" title="加载代码"></a>加载代码</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AddNavMeshOnStart</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> NavMeshData navMeshData;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> NavMeshDataInstance mInstance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (navMeshData != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mInstance = NavMesh.AddNavMeshData(navMeshData, transform.position, transform.rotation);</span><br><span class="line">            Debug.Log(<span class="string">"Add nav mesh data"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>核心代码就是<code>NavMesh.AddNavMeshData(xxxx)</code>. 如果是想Runtime加载,就放在Start里面.如果是想编辑模式就加载则可以加入<code>[ExecuteInEditMode]</code>标签.然后onEnable时候调用.</p>
<p>注意: 在编辑模式下加载则使用<code>Navigation</code>标签下的Clean是无法清除已经加载的NavMesh的<br>需要自己写代码使用<code>NavMesh.RemoveNavMeshData(xxxx);</code>手动清楚掉</p>
<h2 id="用处"><a href="#用处" class="headerlink" title="用处"></a>用处</h2><p>对我个人而言,新版的NavMesh 主要用于 编辑场景和游戏场景分开. 在编辑场景中制作地图,地图中会绑定许多为了做NavMesh而加入的Object. </p>
<p>基于原来的NavMesh系统</p>
<p>一种方案是 编辑结束后,复制整个场景删除无用的GameObject,把当前场景作为游戏场景.<br>另一种方案就是 在场景上绑定清理代码. 在Play的第一帧清除掉无用的GameObject.</p>
<p>第一种方案麻烦的地方在于场景的反复编辑,每次都要执行复制删除.第二种方案在于刚开始Play时候要删GameObject,使得初始化时候会卡.</p>
<p>新的NavMesh可以完美解决这个问题.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oldking.wang/6c4bc820-eb7b-11e7-8403-29e39698c0c1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/6c4bc820-eb7b-11e7-8403-29e39698c0c1/" itemprop="url">Math 向量基于某一坐标轴旋转固定角度</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-28T11:01:38+08:00">
                2017-12-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index">
                    <span itemprop="name">Unity</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171228-105907-HD.gif" alt="QQ20171228-105907-HD"></p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestCode</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Transform target;</span><br><span class="line">    <span class="keyword">public</span> Transform chaser;</span><br><span class="line">    <span class="keyword">public</span> GameObject destination;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> dir = (target.position - chaser.position).normalized;</span><br><span class="line">        <span class="keyword">var</span> fleeDir = Quaternion.AngleAxis(<span class="number">10</span>f, Vector3.up) * dir;</span><br><span class="line">        <span class="keyword">var</span> desPosLocal = fleeDir * <span class="number">3</span>f;</span><br><span class="line">        destination.transform.position = target.transform.TransformPoint(desPosLocal);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//画Flee方向</span></span><br><span class="line">        Debug.DrawRay(target.position, dir * <span class="number">3</span>f, Color.green);</span><br><span class="line"></span><br><span class="line">        Debug.DrawRay(target.position, fleeDir * <span class="number">3</span>f, Color.red);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>dir首先取得的是逃离的方向(目标的局部坐标系)</p>
<figure class="highlight fix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">旋转后向量 </span>=<span class="string"> Quaternion.AngleAxis(旋转角度, 坐标轴) * 原向量</span></span><br></pre></td></tr></table></figure>
<p>该公式可以把某一个向量基于某一个坐标轴旋转指定的角度(欧拉角)</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">target</span><span class="selector-class">.transform</span><span class="selector-class">.TransformPoint</span>(<span class="selector-tag">desPosLocal</span>);</span><br></pre></td></tr></table></figure>
<p>将局部坐标转换为世界坐标</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oldking.wang/dce56270-e88e-11e7-9d4a-778b0cc8b129/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/dce56270-e88e-11e7-9d4a-778b0cc8b129/" itemprop="url">BehaviorDesigner LowerPriority Bug及解决方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-24T17:43:14+08:00">
                2017-12-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这个问题到底是不是一个Bug还不好说,因为是非正规渠道获取的插件,所以没法去论坛提问.我给Support去了一封邮件,不过目前还没有得到答案.</p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171224-173639.jpg" alt="QQ20171224-173639"></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RunAfterTwoSecond</span> : <span class="type">Conditional</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> TaskStatus OnUpdate()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(Time.time &gt; <span class="number">2</span>f)) <span class="keyword">return</span> TaskStatus.Failure;</span><br><span class="line">        Debug.Log(<span class="string">"RunAfterTwoSecond check is TRUE, should run next task"</span>);</span><br><span class="line">        <span class="keyword">return</span> TaskStatus.Success;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如图所示. 逻辑首先会执行<code>TreeB</code>,然后2秒以后.<code>TreeA</code>的判断逻辑会触发成功(因为设置了LowerPriority)</p>
<p>此时会执行一遍<code>TreeA</code>,因为最终结果有<code>Return Failure</code>的装饰.所以又会执行<code>TreeB</code></p>
<p>此时<code>TreeA</code>的条件会一直触发返回<code>TRUE</code>,但是<code>TreeA</code>不会再次运行.</p>
<p>这个Bug触发的条件有两个,一个是<code>RunAfterTwoSecond</code>在2秒以后恒定返回<code>TRUE</code>,且后续逻辑执行导致整个<code>Tree</code>返回了<code>Failure</code>.</p>
<p>第二个条件是,后续的条件逻辑返回的是<code>TaskRunning</code>. 所以导致整个<code>Selector</code>逻辑卡死在同一个loop中.</p>
<p>暂时绕开的解决方案如图:</p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171224-173552.jpg" alt="QQ20171224-173552"></p>
<p>每个有<code>LowerPriority</code>判断的子树,除了需要不停做判断的<code>Conditional</code>以外全部都设置到一个永远返回<code>Success</code>的Deco下面</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oldking.wang/19753c20-e23f-11e7-869e-21b0f4c1ad88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/19753c20-e23f-11e7-869e-21b0f4c1ad88/" itemprop="url">Unity外置ExternalBehavior</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-16T16:57:09+08:00">
                2017-12-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index">
                    <span itemprop="name">Unity</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="为何要外置"><a href="#为何要外置" class="headerlink" title="为何要外置"></a>为何要外置</h2><p><code>Behavior Designer</code>是Unity的一个插件,我用与处理AI逻辑.当AI逻辑很复杂的情况下会使用到<code>ExternalBehavior</code>.</p>
<p><code>ExternalBehavior</code>相当于是<code>BehaviorTree</code>的嵌套. 但是对于多重嵌套情况 他自带的Task支持的并不好.</p>
<p>比如:</p>
<p>一个角色AI,最外层的逻辑可能为<code>发呆</code>,<code>觅食</code>,<code>巡逻</code>等等.</p>
<p><code>觅食</code>和<code>巡逻</code>是两个<code>ExternalBehavior</code>,里面的实现又会用到另外的两个<code>ExternalBehavior</code>,比如<code>移动</code>,<code>攻击</code></p>
<p>这时候我们有两个角色,<code>角色A</code>,<code>角色B</code>. AB两个角色其<code>移动</code>,<code>攻击</code>使用不同的<code>ExternalBehavior</code></p>
<p><code>A-Move</code>,<code>A-Attack</code>,<code>B-Move</code>,<code>B-Attack</code></p>
<p>由于嵌套最里层的<code>ExternalBehavior</code>不同,所以导致上层的<code>觅食</code>,<code>巡逻</code> 也需要有两个. </p>
<p><code>角色A-觅食</code>,<code>角色A-巡逻</code><br><code>角色B-觅食</code>,<code>角色B-巡逻</code></p>
<p>这样如果当AI非常复杂,嵌套层级又多.维护起来非常麻烦.</p>
<h2 id="改进方法"><a href="#改进方法" class="headerlink" title="改进方法"></a>改进方法</h2><p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171216-171241.jpg" alt="QQ20171216-171241"></p>
<p>将对应的<code>ExternalBehavior</code>提到外层的<code>Variables</code>变量中来,利用<code>ExternalBehavior</code>和主的<code>Behavior</code>如果变量名相同则自动Override的特性.将所有的<code>ExternalBehavior</code>放出来.只要保证编写每个<code>ExternalBehavior</code>时候,使用相同的变量名,则自动替换所有的.</p>
<p>还是上面的例子. 建立<code>Variables</code></p>
<ul>
<li>LowLevelAI_Move</li>
<li>LowLevelAI_Attack</li>
<li>HightLevelAI_Eat</li>
<li>HightLevelAI_Patrol</li>
</ul>
<p>这样对于角色A和角色B,Eat和Patrol可以使用同一个<code>ExternalBehavior</code>,只是<code>Move</code>和<code>Attack</code>分别使用不同的.</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>CEExternalBehaviorTree.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义ExternalBehavior</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 使用SharedExternalTree做参数,该参数可以在BD Root处进行设置.这样就可以在外部配置相应的需要Override的BD</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">TaskIcon(<span class="meta-string">"BehaviorTreeReferenceIcon.png"</span>)</span>]</span><br><span class="line">[<span class="meta">TaskCategory(<span class="meta-string">"CopyEngine"</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CEExternalBehaviorTree</span> : <span class="title">BehaviorReference</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> CESharedExternalTree externalTree;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> BehaviorDesigner.Runtime.<span class="function">ExternalBehavior[] <span class="title">GetExternalBehaviors</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (externalTree.Value != <span class="literal">null</span>) <span class="keyword">return</span> <span class="keyword">new</span>[] &#123;externalTree.Value&#125;;</span><br><span class="line">        <span class="keyword">var</span> dummy = CopyEngineFacade.RES.GetRes&lt;BehaviorDesigner.Runtime.ExternalBehavior&gt;(<span class="string">"BD/Dummy"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span>[] &#123;dummy&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CESharedExternalTree.cs</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> CESharedExternalTree : SharedVariable&lt;BehaviorDesigner.Runtime.ExternalBehavior&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> static <span class="keyword">implicit</span> operator CESharedExternalTree(BehaviorDesigner.Runtime.ExternalBehavior <span class="keyword">value</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> new CESharedExternalTree &#123;<span class="keyword">Value</span> = <span class="keyword">value</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CEIsExternalTreeNotNull.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">TaskCategory(<span class="meta-string">"CopyEngine"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CEIsExternalTreeNotNull</span> : <span class="title">Conditional</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> CESharedExternalTree tree;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> BehaviorDesigner.Runtime.ExternalBehavior mDummy;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnAwake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            mDummy = CopyEngineFacade.RES.GetRes&lt;BehaviorDesigner.Runtime.ExternalBehavior&gt;(<span class="string">"BD/Dummy"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> TaskStatus <span class="title">OnUpdate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (tree.Value == <span class="literal">null</span> || tree.Value == mDummy)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> TaskStatus.Failure;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> TaskStatus.Success;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>同时需要在<code>Resources/BD</code>目录下放置一个<code>Dummy</code>的<code>ExternalBehavior</code></p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171216-172214.jpg" alt="QQ20171216-172214"></p>
<p>这么做的操作是为了做判空,因为如果<code>ExternalBehavior</code>默认为空则运行时候就会报错. 而做判空是为了更方便做扩展.</p>
<p>还是刚才的例子,如果角色A和角色B的<code>Move</code>,<code>Attack</code>不同点 一个在于是走,一个是跑,一个是近战攻击,一个是远程攻击.</p>
<p>那就是可以建立一个CommonAI,其变量为:</p>
<ul>
<li>LowLevelAI_Walk</li>
<li>LowLevelAI_Run</li>
<li>LowLevelAI_CloseAttack</li>
<li>LowLevelAI_RangeAttack</li>
<li>HightLevelAI_Eat</li>
<li>HightLevelAI_Patrol</li>
</ul>
<p>这样角色A和角色B可以用同一个<code>BehaviorTree</code>,只是实现不同的行为,没有的默认留空. 内部逻辑通过<code>CEIsExternalTreeNotNull</code>进行判断,从而选择不同的实现方式.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oldking.wang/b09f8040-de81-11e7-ad11-a1cb35453017/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/b09f8040-de81-11e7-ad11-a1cb35453017/" itemprop="url">Unity中使用Protobuf进行网络通讯</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-11T22:43:45+08:00">
                2017-12-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index">
                    <span itemprop="name">Unity</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p><a href="https://developers.google.com/protocol-buffers/" target="_blank" rel="noopener">Protocol Buffers</a>是Google定义的一种数据结构.</p>
<h3 id="本地安装"><a href="#本地安装" class="headerlink" title="本地安装"></a>本地安装</h3><p>安装Protobuf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install protobuf</span><br></pre></td></tr></table></figure>
<p>安装Unity插件<a href="https://github.com/5argon/protobuf-unity" target="_blank" rel="noopener">protobuf-unity</a></p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/15130039913882.png" alt=""></p>
<h3 id="测试Proto"><a href="#测试Proto" class="headerlink" title="测试Proto"></a>测试Proto</h3><p>注意,最好按照 插件中指定的命名方法命名.比如我的Proto名字叫<code>game_proto.proto</code>,最后导出的C#类的名字就是<code>GameProto</code></p>
<p>game_proto.proto</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//commandID 9001</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">TestSyncRequest1</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> user = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//commandID 9001</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">TestSyncResponse1</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> id = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> user = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>插件很高级,当Proto文件变化时候就会直接更新C#的类.很方便.</p>
<p>注意前面需要指定<code>syntax = &quot;proto3&quot;</code></p>
<p>Proto 2 和 3 的区别可以参考 <a href="https://solicomo.com/network-dev/protobuf-proto3-vs-proto2.html" target="_blank" rel="noopener">这篇</a>文章</p>
<h2 id="简单序列与反序列化"><a href="#简单序列与反序列化" class="headerlink" title="简单序列与反序列化"></a>简单序列与反序列化</h2><p>单独使用Proto进行序列化和反序列化很简单,代码如下:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestProto</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnClickTestBtn</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        <span class="keyword">var</span> req1 = <span class="keyword">new</span> TestSyncRequest1();</span><br><span class="line">        req1.User = <span class="string">"ABC"</span>;</span><br><span class="line">        <span class="keyword">var</span> data = req1.ToByteArray();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="keyword">var</span> c = TestSyncRequest1.Parser.ParseFrom(data);</span><br><span class="line">        Debug.Log(c.User);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="网络通讯"><a href="#网络通讯" class="headerlink" title="网络通讯"></a>网络通讯</h2><p>配合网络通讯会稍微有些复杂.主要是有两个问题. </p>
<h3 id="大端-Encoding-BigEndianUnicode-小端-Encoding-Unicode"><a href="#大端-Encoding-BigEndianUnicode-小端-Encoding-Unicode" class="headerlink" title="大端(Encoding.BigEndianUnicode)小端(Encoding.Unicode)"></a>大端(Encoding.BigEndianUnicode)小端(Encoding.Unicode)</h3><p>大端小端就是数据解析的顺序, 比如我的Command定义为9001. Debug byte array 时候会按照8位一转换</p>
<p><code>十进制35 = 二进制 00101101</code><br><code>十进制41 = 二进制 00101001</code><br><code>十进制9001 = 二进制 00100011 00101001</code></p>
<p>大端显示为<code>35,41</code>,小端显示<code>41,35</code></p>
<p>而<code>C#</code>使用<code>BinaryWriter</code>写入<code>MemoryStream</code>时候为<code>小端</code>. 这个要前后端定义好.</p>
<p>而Protobuf的二进制是不分大小端的,具体的可以参考<a href="https://stackoverflow.com/questions/28905274/endianness-of-protocol-buffer-message" target="_blank" rel="noopener">这篇文章</a></p>
<p>也就是说Protobuf部分的数据,直接交给相应的Parser即可进行转换,不用关心大小端的问题.</p>
<p>如果服务器使用的是大端解析的方式,可以使用<a href="https://github.com/jamesqo/Be.IO" target="_blank" rel="noopener">Be.IO</a>这个类库去取代相应的<code>BinaryWriter</code>和<code>BinaryReader</code></p>
<h3 id="Encode和Decode"><a href="#Encode和Decode" class="headerlink" title="Encode和Decode"></a>Encode和Decode</h3><p>从服务器得到的是二进制数据,如果不附加其他信息是无法直接解析的.最基本的需要附加两个信息.</p>
<p>一个信息是CommandID,比如9001.通过这个和9001对应Proto文件知道需要用<code>TestSyncResponse1</code>进行解析该二进制. 第二个是二进制长度(一次需要处理多个数据包儿时候需要用到)</p>
<p>具体示意代码如下</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">byte</span>[] <span class="title">Encode</span>(<span class="params"><span class="keyword">short</span> _commandID, <span class="keyword">byte</span>[] _data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fs = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">    <span class="keyword">var</span> writer = <span class="keyword">new</span> BeBinaryWriter(fs, Encoding.BigEndianUnicode);</span><br><span class="line"></span><br><span class="line">    writer.Write(_commandID);</span><br><span class="line">    writer.Write((<span class="keyword">uint</span>) _data.Length);</span><br><span class="line">    writer.Write(_data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> result = fs.ToArray();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> T Decode&lt;T&gt;(<span class="keyword">byte</span>[] _data) <span class="keyword">where</span> T : IMessage, <span class="keyword">new</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> fs = <span class="keyword">new</span> MemoryStream(_data);</span><br><span class="line">    <span class="keyword">var</span> reader = <span class="keyword">new</span> BeBinaryReader(fs, Encoding.BigEndianUnicode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> command = reader.ReadInt16();</span><br><span class="line">    <span class="keyword">var</span> length = reader.ReadInt32();</span><br><span class="line">    <span class="keyword">var</span> rawData = reader.ReadBytes(length);</span><br><span class="line"></span><br><span class="line">    T message = <span class="keyword">new</span> T();</span><br><span class="line">    message.MergeFrom(rawData);</span><br><span class="line">    <span class="keyword">return</span> message;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h2><p>以上是在知道具体解析类情(泛型T)况下才可,当对网络层进行独立封装时候.往往无法知晓具体类型<br>此时可以单独存储生成ProtoClass的<code>MessageParser</code>.然后向上返回IMessage</p>
<p>Decode函数改为<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> IMessage <span class="title">Decode</span>(<span class="params"><span class="keyword">byte</span>[] _data, MessageParser _parser</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> fs = <span class="keyword">new</span> MemoryStream(_data);</span><br><span class="line">        <span class="keyword">var</span> reader = <span class="keyword">new</span> BeBinaryReader(fs, Encoding.BigEndianUnicode);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> command = reader.ReadInt16();</span><br><span class="line">        <span class="keyword">var</span> length = reader.ReadInt32();</span><br><span class="line">        <span class="keyword">var</span> rawData = reader.ReadBytes(length);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> _parser.ParseFrom(rawData);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>上层封装所有生成类的<code>MessageParser</code>引用<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProtoConfig</span></span></span><br><span class="line"><span class="class">   &#123;</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function">       </span>&#123;</span><br><span class="line">           p = <span class="keyword">new</span> ProtoInfo();</span><br><span class="line">           p.command = <span class="number">9001</span>;</span><br><span class="line">           p.request = TestSyncRequest1.Parser;</span><br><span class="line">           p.response = TestSyncResponse1.Parser;</span><br><span class="line">           mList.Add(p);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span> ProtoInfo p;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>调用方式为</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var a = Decode(response<span class="meta">.Data</span>, ProtoConfig.<span class="keyword">instance.p.response);</span></span><br><span class="line"><span class="keyword">var </span><span class="keyword">b </span>= a as TestSyncResponse1<span class="comment">;</span></span><br><span class="line"><span class="built_in">Debug</span>.Log(<span class="string">"Response ID : "</span> + <span class="keyword">b.Id);</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oldking.wang/d0327b10-dcb5-11e7-902b-4f747c6830ed/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/d0327b10-dcb5-11e7-902b-4f747c6830ed/" itemprop="url">CESDK IOS环境搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-09T15:51:49+08:00">
                2017-12-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index">
                    <span itemprop="name">Unity</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>IOS环境搭建相对于Android来说要简单一些,不过对于我来说难点在于Xcode不熟,并且OC也不会-.-</p>
<h2 id="自动打包"><a href="#自动打包" class="headerlink" title="自动打包"></a>自动打包</h2><h3 id="PostProcessBuild"><a href="#PostProcessBuild" class="headerlink" title="PostProcessBuild"></a>PostProcessBuild</h3><p>在开始构建项目之前,先要解决的是自动打包. Unity在新版中已经提供了<a href="https://docs.unity3d.com/ScriptReference/iOS.Xcode.PBXProject.html" target="_blank" rel="noopener">PBXProject</a>,用起来很方便.</p>
<p>在任意的<code>Editor</code>目录下加入</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XCodeProcessAgent</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="keyword">private</span> PBXProject mProject;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">string</span> mTargetGuid;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">string</span> mProjPath;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Initialize</span><span class="params">(<span class="built_in">string</span> _pathToBuiltProject)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            mProjPath = _pathToBuiltProject + <span class="string">"/Unity-iPhone.xcodeproj/project.pbxproj"</span>;</span><br><span class="line">            mProject = <span class="keyword">new</span> PBXProject();</span><br><span class="line">            mProject.ReadFromFile(mProjPath);</span><br><span class="line">            mTargetGuid = mProject.TargetGuidByName(<span class="string">"Unity-iPhone"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Save</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            mProject.WriteToFile(mProjPath);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddFramework</span><span class="params">(<span class="built_in">string</span> _framework)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            mProject.AddFrameworkToProject(mTargetGuid, _framework, <span class="literal">true</span>);</span><br><span class="line">            Debug.Log(<span class="string">"[CESDK Unity] add framework : "</span> + _framework);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetBuildProperty</span><span class="params">(<span class="built_in">string</span> _property, <span class="built_in">string</span> _value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            mProject.SetBuildProperty(mTargetGuid, _property, _value);</span><br><span class="line">            Debug.Log(<span class="string">"[CESDK Unity] set property : "</span> + _property + <span class="string">" value to: "</span> + _value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">CESDKPostProcessBuild</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//[PostProcessBuild]</span></span><br><span class="line">    [<span class="meta">PostProcessBuild(88)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">onPostProcessBuild</span>(<span class="params">BuildTarget target, <span class="keyword">string</span> pathToBuiltProject</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (target != BuildTarget.iOS)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogWarning(<span class="string">"Target is not iPhone. XCodePostProcess will not run"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Debug.Log(<span class="string">"[CESDK Unity]: Run IOS XCode Process"</span>);</span><br><span class="line"></span><br><span class="line">        EditProject(pathToBuiltProject);</span><br><span class="line"></span><br><span class="line">        Debug.Log(<span class="string">"[CESDK Unity]: Finish"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">EditProject</span>(<span class="params"><span class="keyword">string</span> _pathToBuiltProject</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> agent = <span class="keyword">new</span> XCodeProcessAgent();</span><br><span class="line">        agent.Initialize(_pathToBuiltProject);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//============</span></span><br><span class="line">        <span class="comment">//==添加Framework</span></span><br><span class="line">        <span class="comment">//============</span></span><br><span class="line">        agent.AddFramework(<span class="string">"AVKit.framework"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//===============</span></span><br><span class="line">        <span class="comment">//==设置Property</span></span><br><span class="line">        <span class="comment">//===============</span></span><br><span class="line">        agent.SetBuildProperty(<span class="string">"ENABLE_BITCODE"</span>, <span class="string">"false"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//最后调用保存</span></span><br><span class="line">        agent.Save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://docs.unity3d.com/ScriptReference/Callbacks.PostProcessBuildAttribute.html" target="_blank" rel="noopener">PostProcessBuild</a>标签内部的是执行顺序. 当点击Build时候就会按指定顺序开始执行一个个函数.</p>
<p>目前我接入一个打点SDK,需要自己import一些Framework,然后每次需要更改<code>BitCode=false</code>,至于其他的可以自行添加<br>Mob的ShareSDK内部也有一个<code>PBXProject</code>,应该是他们为了兼容旧版本Unity或者其他原因自己搞了一个. 他们内部也修改了白名单等(用于回调微信等app)</p>
<h3 id="Automatically-Sign"><a href="#Automatically-Sign" class="headerlink" title="Automatically Sign"></a>Automatically Sign</h3><p>自动设置TeamID</p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171208-181634.jpg" alt="QQ20171208-181634"></p>
<p>这个要先在<a href="https://developer.apple.com/account/#/membership/" target="_blank" rel="noopener">官网</a>上查到对应的TeamID</p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171208-181611.jpg" alt="QQ20171208-181611"></p>
<p>然后直接填入PlayerSetting中即可</p>
<h3 id="AppStore-1024x1024-Icon"><a href="#AppStore-1024x1024-Icon" class="headerlink" title="AppStore 1024x1024 Icon"></a>AppStore 1024x1024 Icon</h3><p>直接导出项目会报Warning</p>
<blockquote>
<p>Missing Marketing Icon - iOS Apps must include a 1024x1024px Marketing Icon in PNG format. Apps that do not include the Marketing Icon cannot be submitted for App Review or Beta App Review.</p>
</blockquote>
<p>然后上传AppStore时候也不会让过.</p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171209-163315.jpg" alt="QQ20171209-163315"></p>
<p>需要手动勾选 Override for iOS,然后全部填上对应的Icon即可</p>
<h2 id="相互通讯"><a href="#相互通讯" class="headerlink" title="相互通讯"></a>相互通讯</h2><p>OK,写了<code>PostProcessBuild</code>脚本后,就可以直接导出一个可运行的<code>Xcode</code>项目了. 下一步是尝试写一个可以互相通讯的静态<code>Library</code></p>
<h3 id="创建Library项目"><a href="#创建Library项目" class="headerlink" title="创建Library项目"></a>创建Library项目</h3><p>Xcode直接创建一个静态的Library, 我的叫<code>LibCA</code></p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171209-163500.jpg" alt="QQ20171209-163500"></p>
<h4 id="XCode部分"><a href="#XCode部分" class="headerlink" title="XCode部分"></a>XCode部分</h4><p>更改<code>LibCA.mm</code>为</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"LibCA.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined (__cplusplus)</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">UnitySendMessage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">UnityStringFromNSString</span><span class="params">(NSString* <span class="built_in">string</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* cString = <span class="built_in">string</span>.UTF8String;</span><br><span class="line">        <span class="keyword">char</span>* _unityString = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(cString) + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">strcpy</span>(_unityString, cString);</span><br><span class="line">        <span class="keyword">return</span> _unityString;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">NSString* <span class="title">NSStringFromUnityString</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* unityString_)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (unityString_ == nil) <span class="keyword">return</span> [NSString <span class="keyword">new</span>];</span><br><span class="line">        <span class="keyword">return</span> [NSString stringWithUTF8String:unityString_];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">GetVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">GetMessage</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UnityStringFromNSString(@<span class="string">"CESDK in running"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">NotifyUnity</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        UnitySendMessage(<span class="string">"CESDK"</span>, <span class="string">"NotifyFromXcode"</span>,<span class="string">"&#123;\"age\":15&#125;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined (__cplusplus)</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">@implementation LibCA</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>其中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">UnitySendMessage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *)</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>UnitySendMessage</code>标明<code>extern</code>表示该函数已经在本文件以外(Unity内部函数)定义好了,这里声明一下可以直接使用.</p>
<p>使用的时候</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">UnitySendMessage</span>(<span class="string">"CESDK"</span>, <span class="string">"NotifyFromXcode"</span>,<span class="string">"&#123;\"</span>age\<span class="string">":15&#125;"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>第一个参数:CESDK 是对应的GameObject的Name</li>
<li>第二个参数:NotifyFromXcode 内部函数名</li>
<li>第三个参数:传参,直接用JSON,然后C#内用<code>MinJSON</code>解开即可</li>
</ul>
<h4 id="Unity部分"><a href="#Unity部分" class="headerlink" title="Unity部分"></a>Unity部分</h4><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestButton</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">DllImport(<span class="meta-string">"__Internal"</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">string</span> <span class="title">GetMessage</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">DllImport(<span class="meta-string">"__Internal"</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">NotifyUnity</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CallToGetMessage</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        CELog.Log(<span class="string">"On CallToGetMessage"</span>);</span><br><span class="line">        CELog.Log(<span class="string">"Message is : "</span> + GetMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CallToNotifyUnity</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        CELog.Log(<span class="string">"On CallToNotifyUnity"</span>);</span><br><span class="line">        NotifyUnity();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">NotifyFromXcode</span>(<span class="params"><span class="keyword">string</span> _arg</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        CELog.Log(<span class="string">"Receive msg: "</span> + _arg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171209-164337.jpg" alt="QQ20171209-164337"></p>
<p>写一个<code>MonoBehaviour</code>挂载到根目录叫<code>CESDK</code>的GameObject上面,使用<code>[DllImport(&quot;__Internal&quot;)]</code>表示下面的函数由Xcode内提供,Unity直接调用即可.</p>
<h3 id="自动构建Library"><a href="#自动构建Library" class="headerlink" title="自动构建Library"></a>自动构建Library</h3><p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171209-164841.jpg" alt="QQ20171209-164841"></p>
<p>修改生成的Library,按上图的设置方式,可以直接Copy到Unity的<code>Assets/Plugins</code>目录下. </p>
<p>这样每次改变,只需要在<code>Xcode</code>中执行Command+B即可</p>
<h3 id="遇到的错误"><a href="#遇到的错误" class="headerlink" title="遇到的错误"></a>遇到的错误</h3><h4 id="Invalid-bitcode-signature"><a href="#Invalid-bitcode-signature" class="headerlink" title="Invalid bitcode signature"></a>Invalid bitcode signature</h4><p>导出的Lib运行会报告Bitcode签名有问题,因为我主项目已经禁用了Bitcode<br><img src="http://p09vx6soj.bkt.clouddn.com/47281059.png" alt="47281059"></p>
<p>所以需要在Library项目中也禁用Bitcode<br><img src="http://p09vx6soj.bkt.clouddn.com/47253864.png" alt="47253864"></p>
<h4 id="Apple-Mach-O-Linker-Undefined-symbols-for-architecture-armv7"><a href="#Apple-Mach-O-Linker-Undefined-symbols-for-architecture-armv7" class="headerlink" title="Apple Mach-O Linker Undefined symbols for architecture armv7"></a>Apple Mach-O Linker Undefined symbols for architecture armv7</h4><p>这个困扰我好久,发现如果我在项目中直接写代码,函数就可以找到,如果我以Lib方式引入进来就找不到</p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/47397332.png" alt="47397332"></p>
<p>原因是因为Unity导出的项目 <code>iOS Deployment Target</code> 默认是<code>7.0</code>, 但是Xcode创建新项目,默认则是最新的<code>11.1</code>.</p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171209-165552.jpg" alt="QQ20171209-165552"></p>
<p>直接把Lib项目的Target改成最低<code>8.0</code>即可. </p>
<p>此时项目可以Run,只是会报<code>Warning</code>说Lib是<code>8.0</code>,但是Unity中指定的是<code>7.0</code>不过还是可以运行.</p>
<h3 id="运行效果"><a href="#运行效果" class="headerlink" title="运行效果"></a>运行效果</h3><p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171209-154638.jpg" alt="QQ20171209-154638"></p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p><code>ShareSDK</code>中有一个叫<code>ShareSDKUnity3DBridge</code>的文件. 我理解的他应该是通过<code>PBXProject</code>在Build项目时候,直接将该文件Copy到Class目录下.从而不用写静态库. 虽然不理解这样做的好处. 不过也是个思路. 包括对应<code>Android</code>项目分平台用不同的jar包.也可以先把所有的<code>jar</code>包放工程外,然后通过<code>PBXProject</code>分平台引用不同的<code>Jar</code>从而减小体积.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://oldking.wang/7025e640-db2e-11e7-a265-dda975655901/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="隔壁老王">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="隔壁老王">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/7025e640-db2e-11e7-a265-dda975655901/" itemprop="url">CESDK Android阶段性总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-07T17:10:15+08:00">
                2017-12-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index">
                    <span itemprop="name">Unity</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="原始打算"><a href="#原始打算" class="headerlink" title="原始打算"></a>原始打算</h2><p>打算直接接入微信和QQ的第三方登录,然后微信,QQ和支付宝的支付.不过研究了几天发现要弄的东西有很多,并且即使最后接入成功<br>后续上第三方市场时候会存在二次签名问题.这样微信登录仍旧会失效. 所以暂且先放放 选择直接使用聚合SDK.</p>
<p>不过经过这几天的研究又涨了不少知识.这里做下总结.</p>
<h2 id="Unity导入工程到Intellij"><a href="#Unity导入工程到Intellij" class="headerlink" title="Unity导入工程到Intellij"></a>Unity导入工程到Intellij</h2><p>Unity目前Export有三种方式</p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171207-171739.jpg" alt="QQ20171207-171739"></p>
<p>其中<code>Gradle</code>和<code>ADT</code>都能导出安卓项目,不过尝试过直接导入Intellij.但是均未果. 主要是引入后<code>Gradle</code>都会找不到<code>Gradle Home</code>. 我本地<code>Brew</code>安装了也不行.</p>
<p>后续采取的方法是直接在Intellij中创建新的Android项目.然后将Unity 导出的项目直接复制进去即可.</p>
<h2 id="模拟器调试"><a href="#模拟器调试" class="headerlink" title="模拟器调试"></a>模拟器调试</h2><p>直接安装<a href="http://mumu.163.com/" target="_blank" rel="noopener">网易MuMu</a>,Intellij可以直接认出来,进行真机调试.</p>
<h2 id="应用签名-KeyStore"><a href="#应用签名-KeyStore" class="headerlink" title="应用签名(KeyStore)"></a>应用签名(KeyStore)</h2><p>微信SDK两个难点之一就是这个.</p>
<h3 id="什么是KeyStore"><a href="#什么是KeyStore" class="headerlink" title="什么是KeyStore"></a>什么是KeyStore</h3><p>首先要弄清楚的就是,什么是应用签名.<br><a href="http://blog.csdn.net/jiangwei0910410003/article/details/50402000" target="_blank" rel="noopener">文章一</a>,<a href="http://blog.csdn.net/wzy_1988/article/details/50034711" target="_blank" rel="noopener">文章二</a><br>说的非常详细了.</p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/20151225112950832.png" alt="20151225112950832"></p>
<p>我说下我自己的理解. 签名就是 自己拿着一个密钥生成一个公钥,然后把公钥放进APK里面.然后把这个APK传到应用市场里面,比如GooglePlay.</p>
<p>此时如果别人反编译了APK,改了一些代码.因为没有密钥.所以他在不重新签名的情况无法编译出一个可运行的APK,而重新签名后的APK,又因为签名不同 无法回传到Goolgplay上去. 从而保证了市场里面的APK一定是你(密钥的所有者)传上去的.</p>
<h2 id="如何生成"><a href="#如何生成" class="headerlink" title="如何生成"></a>如何生成</h2><p>Intellij中选择<br><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171207-175933.jpg" alt="QQ20171207-175933"><br><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171207-180955.jpg" alt="QQ20171207-180955"></p>
<p>可以把KeyStore理解为支付宝,上面的那行就是支付宝的密码,而底下的Key0那行就是银行卡的密码. 一个支付宝可以绑定多张银行卡. 也就是能有多个key(key0,key1,key2等).</p>
<h2 id="如何签名"><a href="#如何签名" class="headerlink" title="如何签名"></a>如何签名</h2><h3 id="Gradle"><a href="#Gradle" class="headerlink" title="Gradle"></a>Gradle</h3><p>Gradle中是通过指定<code>signingConfigs</code></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">'com.android.application'</span></span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion <span class="number">26</span></span><br><span class="line">    buildToolsVersion <span class="string">"26.0.1"</span></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId <span class="string">"net.sourceforge.simcpux"</span></span><br><span class="line">        minSdkVersion <span class="number">15</span></span><br><span class="line">        targetSdkVersion <span class="number">26</span></span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName <span class="string">"1.0"</span></span><br><span class="line">        testInstrumentationRunner <span class="string">"android.support.test.runner.AndroidJUnitRunner"</span></span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        debug &#123;</span><br><span class="line">            signingConfig signingConfigs.release</span><br><span class="line">        &#125;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="keyword">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">            signingConfig signingConfigs.release</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    signingConfigs &#123;</span><br><span class="line">        debug &#123;</span><br><span class="line">            storeFile <span class="keyword">file</span>(<span class="string">"../debug.keystore"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        release &#123;</span><br><span class="line">            storeFile <span class="keyword">file</span>(<span class="string">"xxxxxxxxStore"</span>)</span><br><span class="line">            storePassword <span class="string">"xxxxxxxx"</span></span><br><span class="line">            keyAlias <span class="string">"key0"</span></span><br><span class="line">            keyPassword <span class="string">"xxxxxxxx"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span> <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</span><br><span class="line">    androidTestCompile(<span class="string">'com.android.support.test.espresso:espresso-core:2.2.2'</span>, &#123;</span><br><span class="line">        <span class="keyword">exclude</span> <span class="keyword">group</span>: <span class="string">'com.android.support'</span>, module: <span class="string">'support-annotations'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.android.support:appcompat-v7:26.+'</span></span><br><span class="line">    testCompile <span class="string">'junit:junit:4.12'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Unity"><a href="#Unity" class="headerlink" title="Unity"></a>Unity</h3><p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171207-181834.jpg" alt="QQ20171207-181834"></p>
<p>在PlayerSetting中直接指定即可.</p>
<h2 id="如何查看"><a href="#如何查看" class="headerlink" title="如何查看"></a>如何查看</h2><h3 id="Gen-Signature-Android2-apk"><a href="#Gen-Signature-Android2-apk" class="headerlink" title="Gen_Signature_Android2.apk"></a>Gen_Signature_Android2.apk</h3><p>微信SDK中自带了一个<a href="https://res.wx.qq.com/open/zh_CN/htmledition/res/dev/download/sdk/Gen_Signature_Android2.apk" target="_blank" rel="noopener">查看工具Gen Signature Android2</a></p>
<p>安装好后,直接输入需要查看的包名.比如其测试项目包名就是<code>net.sourceforge.simcpux</code></p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/57403754.png" alt="57403754"></p>
<p>上面这张图就是使用Demo中提供的debug.keystore产生的签名</p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/57294445.png" alt="57294445"></p>
<p>这个图的签名是我Unity直接打包生成的APK所产生的签名(Unity默认的debug.keystore). 这也是我之前尝试调试.总出现无法唤起微信,一点发消息直接Crash的原因. 因为签名一直不对…</p>
<h3 id="反编译"><a href="#反编译" class="headerlink" title="反编译"></a>反编译</h3><p>使用<a href="https://ibotpeaches.github.io/Apktool/" target="_blank" rel="noopener">ApkTool</a>反编译项目</p>
<p>在APK所在的目录执行如下命令:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">apktool</span> <span class="selector-tag">d</span> <span class="selector-tag">xxx</span><span class="selector-class">.apk</span></span><br></pre></td></tr></table></figure>
<p>使用<code>keytool</code>查看<code>original/META-INF/CERT.RSA</code></p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -printcert -<span class="keyword">file</span> 解压后的目录/original/META-<span class="literal">INF</span>/CERT.RSA</span><br></pre></td></tr></table></figure>
<p>得到结果</p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/59787968.png" alt="59787968"></p>
<p>可以看到<code>MD5</code>这行的信息和使用微信提供的工具查看到的信息相同.</p>
<p><strong>这行值也是最后需要在微信后台填入的值,否则只能使用Demo项目改(包名和签名都要用他的)要不就会闪退.无法唤起微信</strong></p>
<h2 id="wxapi-WXEntryActivity"><a href="#wxapi-WXEntryActivity" class="headerlink" title="wxapi.WXEntryActivity"></a>wxapi.WXEntryActivity</h2><p>接入微信SDK,必须在包名下含有<code>wxapi.WXEntryActivity</code>类.但是这个Activity不需要是整个App的入口,只要含有这个Activity并且实现了<code>IWXAPIEventHandler</code>接口即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WXEntryActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">IWXAPIEventHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="comment">//注意：</span></span><br><span class="line">        <span class="comment">//第三方开发者如果使用透明界面来实现WXEntryActivity，需要判断handleIntent的返回值，如果返回值为false，则说明入参不合法未被SDK处理，应finish当前透明界面，避免外部通过传递非法参数的Intent导致停留在透明界面，引起用户的疑惑</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Log.i(<span class="string">"Eran"</span>, <span class="string">"Eran-&gt;onCreate"</span>);</span><br><span class="line">            CESDK.instance.GetWeChatAPI().handleIntent(getIntent(), <span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onNewIntent</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onNewIntent(intent);</span><br><span class="line">        Log.i(<span class="string">"Eran"</span>, <span class="string">"Eran-&gt;onNewIntent"</span>);</span><br><span class="line">        setIntent(intent);</span><br><span class="line">        CESDK.instance.GetWeChatAPI().handleIntent(intent, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 微信发送请求到第三方应用时，会回调到该方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReq</span><span class="params">(BaseReq req)</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">"Eran"</span>, <span class="string">"Eran-&gt;onReq"</span>);</span><br><span class="line">        CESDK.instance.GetBridge().Log(<span class="string">"On receive request"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第三方应用发送到微信的请求处理后的响应结果，会回调到该方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResp</span><span class="params">(BaseResp resp)</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">"Eran"</span>, <span class="string">"Eran-&gt;onResp"</span>);</span><br><span class="line">        CESDK.instance.GetBridge().Log(<span class="string">"On receive onResp : "</span> + resp.toString());</span><br><span class="line">        finish();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>收到请求后直接调用<code>finish()</code>结束当前Activity就会返回UnityActivity</p>
<p><strong>注意:</strong> 在<code>AndroidManifest.xml</code>中需要引用这个Activity并且设置<code>exported=true</code>属性</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".wxapi.WXEntryActivity"</span> <span class="attr">android:exported</span>=<span class="string">"true"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="使用Fragment进行Activity扩展-未测试"><a href="#使用Fragment进行Activity扩展-未测试" class="headerlink" title="使用Fragment进行Activity扩展(未测试)"></a>使用Fragment进行Activity扩展(未测试)</h2><p>对于需要Override UnityActivity的扩展,可以考虑使用<code>Fragment</code>. 可以参考<a href="http://eppz.eu/blog/unity-android-plugin-tutorial-1/" target="_blank" rel="noopener">这篇教程</a></p>
<p>普通Override UnityActivity方法<br><img src="http://p09vx6soj.bkt.clouddn.com/Unity_Android_Plugin_Tutorial_Subclassing.png" alt="Unity_Android_Plugin_Tutorial_Subclassing"></p>
<p>使用Fragment方法进行扩展</p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/Unity_Android_Plugin_Tutorial_Compositing.png" alt="Unity_Android_Plugin_Tutorial_Compositing"></p>
<p>代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeChatFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> <span class="keyword">implements</span> <span class="title">IWXAPIEventHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        Log.i(<span class="string">"Eran"</span>, <span class="string">"WeChatFragment on create"</span>);</span><br><span class="line"></span><br><span class="line">        CESDK.instance.GetBridge().Log(<span class="string">"WeChatFragment on create"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// send oauth request</span></span><br><span class="line">        <span class="keyword">final</span> SendAuth.Req req = <span class="keyword">new</span> SendAuth.Req();</span><br><span class="line">        req.scope = <span class="string">"snsapi_userinfo"</span>;</span><br><span class="line">        req.state = <span class="string">"none"</span>;</span><br><span class="line">        CESDK.instance.GetWeChatAPI().sendReq(req);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReq</span><span class="params">(BaseReq baseReq)</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">"Eran"</span>, <span class="string">"Eran-&gt;onReq"</span>);</span><br><span class="line">        CESDK.instance.GetBridge().Log(<span class="string">"Eran-&gt;onReq"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResp</span><span class="params">(BaseResp baseResp)</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">"Eran"</span>, <span class="string">"Eran-&gt;onResp"</span>);</span><br><span class="line">        CESDK.instance.GetBridge().Log(<span class="string">"Eran-&gt;onResp"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在任意函数调用,将Fragment添加到当前的主Activity中来即可</p>
<figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WeChatFragment</span> fragment = <span class="function"><span class="keyword">new</span> <span class="title">WeChatFragment</span>();</span></span><br><span class="line"><span class="function"><span class="title">mBridge</span>.<span class="title">GetUnityMainActivity</span>().<span class="title">getFragmentManager</span>().<span class="title">beginTransaction</span>().<span class="title">add</span>(fragment, "<span class="type">TAG_ABD</span>").<span class="title">commit</span>();</span></span><br></pre></td></tr></table></figure>
<p>但是由于后来了解到<code>WXEntryActivity</code>不用为入口Activity,所以也没有深入研究.</p>
<h2 id="获取wechat-sdk-android-without-mta-5-1-0-jar"><a href="#获取wechat-sdk-android-without-mta-5-1-0-jar" class="headerlink" title="获取wechat-sdk-android-without-mta-5.1.0.jar"></a>获取wechat-sdk-android-without-mta-5.1.0.jar</h2><p>因为不用重载UnityActivity,所以可以将接入部分直接作为lib库,以导入<code>jar</code>包的方式引用<code>Unity</code>.这样每次发版本时候,就不用导入Intellij 然后再发布APK了.</p>
<p>但是现在的项目都采用<code>Gradle</code>构建了,在工程目录下是找不到jar包的. 微信的SDK还好,其官网提供<code>Eclipse</code>工程,目录下有对应的jar包.不过上面也写了.从<code>4.0.2</code>版本以后都改为<code>Gradle</code>构建了. </p>
<p>那<code>Gradle</code>的jar包在哪里呢?</p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171207-225650.jpg" alt="QQ20171207-225650"></p>
<p>可以参照<a href="http://www.xiuzhen.me/2017/0b131150-d98b-11e7-b3ad-5130597fcc90/" target="_blank" rel="noopener">Android环境搭建</a>里面的步骤,构建相应的SDK.</p>
<p>因为这种方法仍旧是使用的<code>Gradle</code>进行打包,所以最终生成的jar包不会包含依赖库. 也就是<code>wechat-sdk-android-without-mta-5.1.0.jar</code>. </p>
<p>所以需要把生成好的jar包和微信的这个SDK一起拷贝的Unity<strong>任意目录</strong>即可. </p>
<p>注意<strong>不能</strong>在<code>/Plugins/Android/任意文件夹/libs</code>目录. 因为这样会导致jar包被重复打包,导入jar文件冲突(DEX xxx 什么的错误).</p>
<h2 id="Unity合并AndroidManifest-xml"><a href="#Unity合并AndroidManifest-xml" class="headerlink" title="Unity合并AndroidManifest.xml"></a>Unity合并AndroidManifest.xml</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>因为<code>wxapi.WXEntryActivity</code>的问题,在<code>AndroidManifest.xml</code>中必须导出这个Activity,而使用Unity直接打包,就需要给最终的<code>AndroidManifest.xml</code>加入这部分信息.</p>
<p>Unity规定</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/Plugins/</span>Android<span class="regexp">/任意文件夹/</span>AndroidManifest.xml</span><br></pre></td></tr></table></figure>
<p>在Android子文件夹下的<code>AndroidManifest.xml</code>文件会Merge到最终的<code>AndroidManifest.xml</code>中来. </p>
<p>如果存在<code>/Plugins/Android/AndroidManifest.xml</code>则使用该<code>AndroidManifest.xml</code>作为初始的模板,如果不存在则使用默认的.</p>
<h3 id="project-properties"><a href="#project-properties" class="headerlink" title="project.properties"></a>project.properties</h3><p>之前试了好几次都不行,困扰了我半天. 后来发现是因为子目录中没有包含<code>project.properties</code>文件.</p>
<p>每个子目录中必须包含一个<code>project.properties</code>文件,然后里面有一行</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android.<span class="keyword">library</span>=<span class="keyword">true</span></span><br></pre></td></tr></table></figure>
<p>用以指定这个子目录是库目录,这样其下的<code>AndroidManifest.xml</code>文件才会被merge进来.</p>
<h3 id="查看方法"><a href="#查看方法" class="headerlink" title="查看方法"></a>查看方法</h3><p>如果使用<code>Gradle</code>导出项目,不能直接查看到Merge情况.</p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171207-231253.jpg" alt="QQ20171207-231253"></p>
<p>生成的工程回导出两个项目来,所以此时<code>AndroidManifest.xml</code>会有两个,还没有Merge</p>
<p><img src="http://p09vx6soj.bkt.clouddn.com/QQ20171207-231334.jpg" alt="QQ20171207-231334"></p>
<p>并且从主的<code>build.gradle</code>可以看出来. 主项目是依赖于<code>CESDK</code>这个项目的.</p>
<p>其实这个只要知道其内部肯定会Merge的就ok了,反正最终也不会真的导出<code>Gradle</code>项目再编译.</p>
<p>不过如果还是不放心,或有异常错误. 可以直接<code>ApkTool</code>反编译生成好的APK,其内部的<code>AndroidManifest.xml</code>就是最终的了.</p>
<h2 id="放弃转而使用聚合SDK的原因"><a href="#放弃转而使用聚合SDK的原因" class="headerlink" title="放弃转而使用聚合SDK的原因"></a>放弃转而使用聚合SDK的原因</h2><p>其实研究了上面的种种问题,Android SDK这边应该已经弄的七七八八了. 理论是可以直接接入微信SDK的了,不够后续还是打算直接使用聚合SDK. 主要是考虑到最终上某些安卓市场时候会存在 二次签名的情况. 一旦二次签名了. 那肯定和微信后台配的签名不同了 这样肯定是没法微信登录的.</p>
<p>后来又看了<a href="http://www.wjdiankong.cn/android%E4%B8%AD%E8%A7%A3%E5%86%B3%E7%A0%B4%E8%A7%A3%E7%AD%BE%E5%90%8D%E9%AA%8C%E8%AF%81%E4%B9%8B%E5%90%8E%E5%AF%BC%E8%87%B4%E7%9A%84%E7%99%BB%E5%BD%95%E6%8E%88%E6%9D%83%E5%A4%B1%E6%95%88%E9%97%AE/" target="_blank" rel="noopener">这篇文章</a>,感觉应该是这些聚合SDK采用了其他的方式,绕开了二次签名的问题.<br>所以目前还是先采用聚合SDK. 后续再看是否需要自己去写.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">隔壁老王</p>
              <p class="site-description motion-element" itemprop="description">独立游戏开发者</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">隔壁老王</span>

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
